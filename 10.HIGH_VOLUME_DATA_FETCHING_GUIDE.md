# Hướng Dẫn: Tải Dữ liệu Lịch sử Số lượng lớn Hiệu quả

## Giới thiệu

Khi cần backfill (lấp đầy) dữ liệu lịch sử cho các báo cáo như "Sponsored Products Search Term", "Sponsored Brands Search Term", hoặc "Sponsored Display Targeting", việc chạy script cho từng ngày một và chờ đợi có thể mất hàng giờ hoặc thậm chí hàng ngày. Hướng dẫn này mô tả một quy trình hai giai đoạn, hiệu quả hơn nhiều, cho phép bạn yêu cầu hàng loạt báo cáo và sau đó xử lý chúng một cách tự động.

**Quy trình này giải quyết vấn đề:** Chờ đợi Amazon tạo báo cáo là giai đoạn tốn thời gian nhất. Thay vì yêu cầu và chờ đợi tuần tự, chúng ta sẽ yêu cầu tất cả cùng một lúc và để Amazon xử lý chúng song song.

---

## Yêu cầu

-   Bạn đã chạy file migration `005_add_report_requests_table.sql.txt` để tạo bảng `report_requests`. Bảng này đóng vai trò là hàng đợi (queue) để theo dõi các yêu cầu. Chạy lệnh sau trong `psql` nếu bạn chưa làm:
    ```sql
    \i /var/www/Gadnia-Ads-Auto/backend/migrations/005_add_report_requests_table.sql.txt
    ```

---

## Quy trình Hai Giai đoạn

### Giai đoạn 1: Gửi Yêu cầu Hàng loạt (Chạy một lần)

Ở giai đoạn này, chúng ta sẽ sử dụng các script `request:sp-search-terms`, `request:sb-search-terms`, và `request:sd-targeting`. Các script này sẽ lặp qua từng ngày trong khoảng thời gian bạn chỉ định và gửi yêu cầu tạo báo cáo đến Amazon. Chúng **không chờ đợi** báo cáo hoàn thành, mà chỉ lấy `reportId` và lưu nó vào hàng đợi trong bảng `report_requests`.

1.  **Mở terminal trên VPS của bạn** và di chuyển đến thư mục gốc của dự án.
2.  **Chạy các script với khoảng thời gian bạn muốn backfill.**
    -   Ví dụ: để yêu cầu báo cáo cho toàn bộ tháng 8 năm 2024 cho tất cả các loại quảng cáo:
    ```bash
    # Sponsored Products
    npm run request:sp-search-terms -- 2024-08-01 2024-08-31

    # Sponsored Brands
    npm run request:sb-search-terms -- 2024-08-01 2024-08-31

    # Sponsored Display
    npm run request:sd-targeting -- 2024-08-01 2024-08-31
    ```
3.  **Kết quả:** Các script này sẽ chạy rất nhanh và kết thúc sau vài phút. Khi hoàn tất, bảng `report_requests` của bạn sẽ chứa đầy các yêu cầu đang ở trạng thái `PENDING`.

**Quan trọng:** Sau khi chạy xong Giai đoạn 1, bạn cần **chờ ít nhất 1-2 tiếng** để Amazon có thời gian xử lý và tạo các báo cáo này.

---

### Giai đoạn 2: Xử lý các Báo cáo đang chờ (Chạy định kỳ)

Sau khi đã chờ đủ lâu, chúng ta sẽ sử dụng script `2.process_pending_reports.js`. Script này sẽ kiểm tra hàng đợi, tìm các báo cáo đã hoàn thành, tải chúng về, và lưu dữ liệu.

#### Cách 1: Chạy thủ công

Bạn có thể chạy script này thủ công để kiểm tra.

```bash
npm run process:pending-reports
```
-   Script sẽ quét qua tất cả các báo cáo `PENDING`. Với những báo cáo đã `COMPLETED`, nó sẽ tải về và xử lý. Với những báo cáo vẫn đang được tạo, nó sẽ bỏ qua và bạn có thể chạy lại script sau.

#### Cách 2: Tự động hóa với Cron (Khuyến nghị)

Cách tốt nhất là thiết lập một cron job để tự động chạy script xử lý này, ví dụ, mỗi 15 hoặc 45 phút một lần.

1.  **Mở trình chỉnh sửa crontab:**
    ```bash
    crontab -e
    ```
2.  **Thêm dòng sau vào cuối file.**
    -   Hãy thay thế `/var/www/Gadnia-Ads-Auto` bằng đường dẫn **CHÍNH XÁC** đến thư mục dự án của bạn.
    -   `*/45 * * * *` có nghĩa là "chạy vào các phút 0 và 45 của mỗi giờ".

    ```cron
    # Tự động xử lý các báo cáo đang chờ trong hàng đợi mỗi 45 phút
    */45 * * * * cd /var/www/Gadnia-Ads-Auto && npm run process:pending-reports >> /var/www/Gadnia-Ads-Auto/logs/process_pending_reports.log 2>&1
    ```

3.  **Lưu và Thoát:**
    -   Nhấn `Ctrl + X`, sau đó `Y`, và `Enter`.

**Bây giờ, hệ thống của bạn đã hoàn toàn tự động.** Cron job sẽ liên tục kiểm tra và xử lý các báo cáo ngay khi chúng sẵn sàng. Bạn có thể kiểm tra file log tại `/var/www/Gadnia-Ads-Auto/logs/process_pending_reports.log` để xem tiến trình.

---

## Tóm tắt quy trình Backfill

1.  **Chạy migration** để tạo bảng `report_requests` và các bảng báo cáo cho SP, SB, SD.
2.  **Chạy Giai đoạn 1 một lần:** `npm run request:sp-search-terms -- [start_date] [end_date]`, và tương tự cho SB, SD.
3.  **Chờ 1-2 tiếng.**
4.  **Thiết lập cron job cho Giai đoạn 2:** Thêm dòng cron job để chạy `npm run process:pending-reports` định kỳ.
5.  (Tùy chọn) Theo dõi file log để xem dữ liệu được tải về.

Sau vài giờ, toàn bộ dữ liệu lịch sử của bạn sẽ được lấp đầy trong database một cách hiệu quả và tự động.