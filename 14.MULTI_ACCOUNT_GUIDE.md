# Hướng dẫn Tích hợp Nhiều Tài khoản Quảng cáo Amazon

## 1. Mục tiêu

Tài liệu này hướng dẫn bạn cách tái cấu trúc ứng dụng để có thể quản lý nhiều tài khoản quảng cáo Amazon riêng biệt, mỗi tài khoản có bộ API credentials (Client ID, Client Secret, Refresh Token) của riêng mình.

-   **Hiện trạng:** Ứng dụng chỉ hỗ trợ một tài khoản duy nhất thông qua các biến môi trường trong file `backend/.env`.
-   **Mục tiêu:** Cho phép người dùng thêm, sửa, xóa nhiều tài khoản và chuyển đổi giữa chúng một cách linh hoạt ngay trên giao diện người dùng.

---

## 2. Tổng quan Kiến trúc Mới

Để đạt được mục tiêu này, chúng ta sẽ thực hiện ba thay đổi lớn:

1.  **Credentials trong Database:** Thay vì lưu trong file `.env`, thông tin API của mỗi tài khoản sẽ được lưu vào một bảng mới trong PostgreSQL.
2.  **API Đa tài khoản:** Backend sẽ được cập nhật để có thể sử dụng bộ credentials tương ứng với tài khoản mà người dùng chọn trên frontend.
3.  **Giao diện Quản lý Tài khoản:** Một trang mới sẽ được tạo để người dùng tự quản lý các tài khoản Amazon của họ.

---

## 3. Phần 1: Cập nhật Cơ sở dữ liệu

Chúng ta cần một bảng mới để lưu trữ thông tin các tài khoản một cách an toàn.

1.  **Kết nối vào PostgreSQL của bạn:**
    ```bash
    sudo -u postgres psql -d amazon_data_gadnia
    ```

2.  **Chạy lệnh SQL sau để tạo bảng `amazon_accounts`:**
    ```sql
    -- Bảng lưu trữ thông tin của nhiều tài khoản Amazon Ads
    CREATE TABLE IF NOT EXISTS amazon_accounts (
        id SERIAL PRIMARY KEY,
        account_name TEXT NOT NULL UNIQUE,
        client_id TEXT NOT NULL,
        client_secret TEXT NOT NULL,
        -- QUAN TRỌNG: Trong môi trường production thực tế, refresh token
        -- PHẢI được mã hóa trước khi lưu vào database.
        refresh_token TEXT NOT NULL,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    -- Tạo trigger để tự động cập nhật cột updated_at
    CREATE OR REPLACE FUNCTION trigger_set_timestamp()
    RETURNS TRIGGER AS $$
    BEGIN
      NEW.updated_at = NOW();
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    DROP TRIGGER IF EXISTS set_timestamp_accounts ON amazon_accounts;
    CREATE TRIGGER set_timestamp_accounts
    BEFORE UPDATE ON amazon_accounts
    FOR EACH ROW
    EXECUTE PROCEDURE trigger_set_timestamp();

    -- Cấp quyền cho user của ứng dụng (thay 'gadnia' bằng user của bạn)
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE amazon_accounts TO gadnia;
    GRANT USAGE, SELECT ON SEQUENCE amazon_accounts_id_seq TO gadnia;
    ```

3.  **Thoát psql:** gõ `\q` và nhấn Enter.

---

## 4. Phần 2: Cập nhật Backend

### 4.1. Tạo API Endpoints mới để quản lý tài khoản

-   Tạo một file router mới: `backend/routes/accounts.js`.
-   File này sẽ định nghĩa các endpoint CRUD (Create, Read, Update, Delete) cho các tài khoản:
    -   `GET /api/accounts`: Lấy danh sách tất cả các tài khoản (chỉ lấy `id` và `account_name`).
    -   `POST /api/accounts`: Thêm một tài khoản mới.
    -   `PUT /api/accounts/:id`: Cập nhật thông tin một tài khoản.
    -   `DELETE /api/accounts/:id`: Xóa một tài khoản.

### 4.2. Cập nhật Logic Lấy Access Token

File `backend/helpers/amazon-api.js` cần được sửa đổi đáng kể.

-   **`getAdsApiAccessToken(accountId)`:** Hàm này bây giờ phải nhận vào một `accountId`.
    -   Nó sẽ dùng `accountId` để truy vấn bảng `amazon_accounts` và lấy ra `client_id`, `client_secret`, `refresh_token` tương ứng.
    -   Nó sẽ sử dụng các credentials này để gọi đến Amazon LWA và lấy access token.
-   **Token Cache:** Biến cache `adsApiTokenCache` không thể là một biến toàn cục đơn lẻ nữa. Nó phải là một object (hoặc Map) để lưu trữ token cho mỗi tài khoản, ví dụ: `let tokenCache = {}; tokenCache[accountId] = { token, expiresAt };`.

### 4.3. Cập nhật các API hiện có

-   Tất cả các hàm gọi API Amazon hiện có (ví dụ: `POST /api/amazon/campaigns/list`) bây giờ phải nhận thêm một tham số `accountId` từ frontend.
-   Tham số này sẽ được truyền xuống `getAdsApiAccessToken` để đảm bảo hệ thống đang sử dụng đúng bộ credentials.

---

## 5. Phần 3: Cập nhật Frontend

### 5.1. Tạo Giao diện Quản lý Tài khoản

-   Tạo một view mới, ví dụ: `views/AccountsView.tsx`.
-   Thêm một route mới `/accounts` trong `index.tsx` để trỏ đến view này.
-   Thêm một link "Accounts" vào thanh điều hướng trong `Layout.tsx`.
-   Giao diện này sẽ có:
    -   Một bảng hiển thị danh sách các tài khoản đã thêm.
    -   Một nút "Add New Account" để mở một form cho phép người dùng nhập: Tên tài khoản (để dễ nhận biết), Client ID, Client Secret, và Refresh Token.

### 5.2. Cập nhật Trang PPC Management

Trang `views/PPCManagementView.tsx` cần được nâng cấp:

1.  **Thêm Dropdown Chọn Tài khoản:**
    -   Thêm một dropdown mới **"Account"** nằm ngay trước dropdown "Profile".
    -   Dropdown này sẽ được điền bằng cách gọi API `GET /api/accounts`.
    -   Khi người dùng chọn một tài khoản, `accountId` của tài khoản đó sẽ được lưu vào `localStorage`.

2.  **Cập nhật Luồng Lấy Dữ liệu:**
    -   Khi dropdown "Account" thay đổi, dropdown "Profile" sẽ được làm mới bằng cách gọi `GET /api/amazon/profiles` và truyền `accountId` đã chọn.
    -   Tất cả các lệnh gọi API khác trên trang này (lấy campaigns, metrics, cập nhật campaigns...) đều phải gửi kèm `accountId` đang được chọn.

---

## 6. Phần 5: Di chuyển Credentials từ `.env`

Sau khi đã hoàn thành các thay đổi trên, bạn cần di chuyển bộ credentials đầu tiên từ file `.env` vào database.

1.  Lấy các giá trị `ADS_API_CLIENT_ID`, `ADS_API_CLIENT_SECRET`, `ADS_API_REFRESH_TOKEN` từ file `backend/.env`.
2.  Sử dụng giao diện "Accounts" bạn vừa tạo, nhấp "Add New Account".
3.  Điền các thông tin đã lấy, đặt tên là "Tài khoản Mặc định" (hoặc tên nào đó dễ nhận biết).
4.  Lưu lại.
5.  **Quan trọng:** Sau khi đã di chuyển thành công, bạn có thể xóa các biến này khỏi file `.env` để tránh nhầm lẫn và đảm bảo hệ thống chỉ đọc credentials từ database.

Chúc mừng! Ứng dụng của bạn giờ đây đã sẵn sàng để quản lý nhiều tài khoản quảng cáo Amazon một cách chuyên nghiệp và có khả năng mở rộng.