# Hướng Dẫn (Bảo mật): Kích hoạt HTTPS Miễn phí với Let's Encrypt & Certbot

## Giới thiệu

Xin chào! Lỗi `fetch failed` mà bạn gặp trong Lambda là do Lambda đang cố gắng kết nối đến backend của bạn qua `https://` (một kết nối an toàn), nhưng web server Nginx trên VPS của bạn chưa được cấu hình để xử lý các kết nối này (nó chỉ đang nghe ở cổng 80, là `http://`).

Hướng dẫn này sẽ chỉ cho bạn cách cài đặt một chứng chỉ SSL/TLS miễn phí từ Let's Encrypt bằng công cụ Certbot. Việc này sẽ kích hoạt HTTPS, giúp mã hóa toàn bộ dữ liệu giữa người dùng và server, đồng thời giải quyết triệt để lỗi kết nối của Lambda.

**Ưu điểm:**
-   **Miễn phí và Tự động:** Certbot tự động hóa toàn bộ quá trình lấy và gia hạn chứng chỉ.
-   **Bảo mật Tối đa:** Kích hoạt mã hóa HTTPS (biểu tượng ổ khóa trên trình duyệt).
-   **Yêu cầu Bắt buộc:** Cần thiết để Lambda có thể giao tiếp với API endpoint của bạn.

---

## Yêu cầu

-   Bạn đã có một VPS Ubuntu 22.04 với Nginx đang chạy.
-   Bạn đã có một tên miền (ví dụ: `gadnia.tababyco.com`) trỏ đến địa chỉ IP công khai của VPS.

---

## Các bước Thực hiện

### Bước 1: Cài đặt Certbot

Certbot được khuyến nghị cài đặt qua `snapd`, một hệ thống quản lý gói hiện đại.

1.  Đảm bảo `snapd` được cập nhật:
    ```bash
    sudo snap install core; sudo snap refresh core
    ```
2.  Xóa các phiên bản Certbot cũ (nếu có) để tránh xung đột:
    ```bash
    sudo apt-get remove certbot
    ```
3.  Cài đặt Certbot bằng snap:
    ```bash
    sudo snap install --classic certbot
    ```
4.  Tạo một liên kết tượng trưng để lệnh `certbot` có thể được chạy từ bất kỳ đâu:
    ```bash
    sudo ln -s /snap/bin/certbot /usr/bin/certbot
    ```

### Bước 2: Kiểm tra Cấu hình Nginx

Trước khi lấy chứng chỉ, hãy đảm bảo file cấu hình Nginx của bạn đã đúng.
- Mở file cấu hình: `sudo nano /etc/nginx/sites-available/gadnia.tababyco.com`
- Tìm dòng `server_name` và đảm bảo nó khớp chính xác với tên miền của bạn. Ví dụ: `server_name gadnia.tababyco.com;`.

### Bước 3: Lấy Chứng chỉ SSL và Cấu hình Nginx Tự động

Đây là bước kỳ diệu. Certbot sẽ tự động giao tiếp với Let's Encrypt, lấy chứng chỉ và chỉnh sửa file cấu hình Nginx cho bạn.

1.  Chạy lệnh sau:
    ```bash
    sudo certbot --nginx
    ```
2.  **Certbot sẽ hỏi bạn một vài câu:**
    -   **Email address:** Nhập địa chỉ email của bạn. Dùng để gửi thông báo khi chứng chỉ sắp hết hạn.
    -   **Terms of Service:** Gõ `A` và Enter để đồng ý.
    -   **Mailing list:** Gõ `Y` hoặc `N` tùy bạn.
    -   **Which names would you like to activate HTTPS for?:** Certbot sẽ hiển thị danh sách các tên miền nó tìm thấy trong Nginx. Nếu chỉ có một, nó sẽ được chọn sẵn. Nhấn `Enter` để xác nhận.

3.  **Kết quả:** Certbot sẽ hoàn tất quá trình xác thực và cấu hình lại Nginx để sử dụng chứng chỉ mới. Nó cũng sẽ tự động thiết lập chuyển hướng (redirect) từ HTTP sang HTTPS.

### Bước 4: Cập nhật Cấu hình Nginx với Basic Authentication

Bây giờ Nginx đã được cấu hình cho HTTPS, chúng ta cần đảm bảo các quy tắc Basic Authentication nằm đúng chỗ. Certbot đã tạo ra một file cấu hình mới (hoặc sửa đổi file cũ) với hai khối `server`: một cho HTTP (chuyển hướng) và một cho HTTPS.

Hãy làm theo **Hướng dẫn 5 (Nginx Basic Auth)** để cập nhật lại file cấu hình Nginx của bạn. Cấu trúc cuối cùng sẽ trông giống như ví dụ trong hướng dẫn đó, với các quy tắc `auth_basic` được đặt bên trong khối `server { listen 443 ssl; ... }`.

### Bước 5: Kiểm tra Gia hạn Tự động

Gói Certbot bạn đã cài đặt sẽ tự động tạo một cron job hoặc systemd timer để kiểm tra và gia hạn chứng chỉ 60 ngày một lần. Bạn không cần làm gì thêm, nhưng có thể kiểm tra xem nó có hoạt động không.

1.  Chạy lệnh kiểm tra gia hạn (không thực sự gia hạn, chỉ mô phỏng):
    ```bash
    sudo certbot renew --dry-run
    ```
    -   Nếu không có lỗi, bạn đã sẵn sàng.

---

## Hoàn tất!

Chúc mừng! Trang web của bạn hiện đã được bảo vệ hoàn toàn bằng HTTPS. Lỗi `fetch failed` trong Lambda sẽ được giải quyết. Bây giờ, bạn có thể truy cập trang web của mình qua `https://gadnia.tababyco.com` và bạn sẽ thấy biểu tượng ổ khóa an toàn trên trình duyệt.