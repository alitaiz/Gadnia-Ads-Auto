# Hướng dẫn Tích hợp Amazon Marketing Stream với PostgreSQL (Phương pháp API Endpoint tiết kiệm)

## Mục tiêu

Tài liệu này hướng dẫn bạn cách thiết lập một pipeline dữ liệu **hybrid**, **chi phí cực thấp** để nhận, xử lý và ghi dữ liệu từ Amazon Marketing Stream vào cơ sở dữ liệu **PostgreSQL** đang chạy trên VPS Ubuntu 22.04.


> **Lưu ý về Lựa chọn Dataset:** Hướng dẫn này sử dụng đồng thời hai dataset: `sp-traffic` (impressions, clicks, cost) và `sp-conversion` (orders, sales) để có được một dashboard PPC toàn diện.

---

## Tổng quan Kiến trúc Hybrid (Chi phí thấp)

**Luồng Ghi dữ liệu (Data Ingestion):**
`Amazon Ads API` → `AWS Kinesis Data Firehose` → `AWS Lambda (gadnia-process-and-forward-stream)` → `Internet (HTTPS)` → `Backend API (trên VPS)` → `PostgreSQL (trên VPS)`

---

## Phân tích Chi phí (Cost Analysis)

-   **Kinesis Data Firehose:** Rất thấp, ~$0.029/GB.
-   **AWS Lambda:** Gói miễn phí lớn, chi phí gần như **$0/tháng**.
-   **VPS Ubuntu:** Chi phí không đổi.

**Tổng chi phí ước tính trên AWS: ~$0-2/tháng.**

---

## Yêu cầu

1.  **Tài khoản AWS & AWS CLI.**
2.  **VPS Ubuntu 22.04** với PostgreSQL và backend Node.js/Express đang chạy.
3.  **Một tên miền** trỏ đến IP của VPS.
4.  **Quyền Admin trên Amazon Ads.**

---

## Phần 1: Cấu hình VPS và Backend API

### Bước 1: Tạo và Cấp quyền cho Bảng Dữ liệu Stream
Bảng này sẽ lưu trữ dữ liệu thô nhận được từ Lambda. Chúng ta không chỉ tạo bảng mà còn phải **cấp quyền** cho người dùng của ứng dụng để có thể ghi dữ liệu vào đó. Đây là bước quan trọng để sửa lỗi "Failed to write data to database".

1.  **Đăng nhập vào VPS của bạn qua SSH.**
2.  **Kết nối vào PostgreSQL:** Chạy lệnh sau để kết nối trực tiếp vào database `amazon_data_gadnia` với quyền quản trị:
    ```bash
    sudo -u postgres psql -d amazon_data_gadnia
    ```
3.  **Chạy lệnh SQL tạo bảng và cấp quyền:** Sau khi vào được giao diện của `psql` (dấu nhắc sẽ đổi thành `amazon_data_gadnia=#`), hãy sao chép (copy) **CHÍNH XÁC** toàn bộ nội dung SQL bên dưới. **Đừng quên thay đổi `gadnia`** thành tên người dùng database mà bạn đã cấu hình trong file `backend/.env`.

    ```sql
    -- Bảng lưu trữ dữ liệu stream thô từ Amazon Marketing Stream
    CREATE TABLE IF NOT EXISTS raw_stream_events (
        id SERIAL PRIMARY KEY,
        event_type TEXT,
        event_data JSONB,
        received_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Tạo chỉ mục để tăng tốc độ truy vấn
    CREATE INDEX IF NOT EXISTS idx_rse_received_at ON raw_stream_events (received_at DESC);
    CREATE INDEX IF NOT EXISTS idx_rse_event_type ON raw_stream_events (event_type);

    -- =========================================================================
    -- == BƯỚC QUAN TRỌNG: Cấp quyền cho user của ứng dụng                     ==
    -- == Thay thế 'gadnia' bằng DB_USER thực tế từ file .env của bạn.       ==
    -- =========================================================================
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE raw_stream_events TO gadnia;
    GRANT USAGE, SELECT ON SEQUENCE raw_stream_events_id_seq TO gadnia;
    ```
    Sau khi dán và chỉnh sửa, nhấn Enter để thực thi các lệnh.

4.  **Thoát khỏi PostgreSQL:** Gõ lệnh `\q` và nhấn Enter để quay lại terminal bình thường.

### Bước 2: Cập nhật Backend để Nhận Dữ liệu Stream
Chúng ta sẽ cập nhật backend để có thể **nhận** dữ liệu từ Lambda và cung cấp dữ liệu cho frontend.

#### 2A. Cập nhật `backend/routes/stream.js`
File này là nơi định nghĩa các API endpoint liên quan đến stream. Nó đã được cập nhật để xử lý cả hai nhiệm vụ:
-   **`POST /api/stream-ingest`**: Đây là một endpoint bảo mật mới, chỉ nhận dữ liệu từ AWS Lambda (được xác thực bằng một API key bí mật). Nó nhận các sự kiện stream và ghi chúng vào bảng `raw_stream_events` trong PostgreSQL.
-   **`GET /api/stream/metrics`**: Endpoint này dùng để cung cấp các chỉ số tổng hợp cho frontend.

#### 2B. Xác minh `backend/server.js`
File `backend/server.js` là file "lắp ráp" toàn bộ ứng dụng. Để các endpoint trong `stream.js` có thể được truy cập từ bên ngoài, `server.js` phải "đăng ký" chúng.

**Giải thích:**
-   **`server.js`** tạo ra ứng dụng `app` chính.
-   **`stream.js`** tạo ra một `router` (bộ định tuyến) chứa các endpoint chuyên biệt.
-   Lệnh `app.use('/api', streamRoutes);` trong `server.js` đóng vai trò là "cầu nối", ra lệnh cho ứng dụng chính: "Tất cả các yêu cầu (request) có đường dẫn bắt đầu bằng `/api` hãy chuyển cho `streamRoutes` xử lý".

**Hành động:** Mở file `backend/server.js` và **đảm bảo** rằng các dòng sau đã tồn tại. Nếu chưa, hãy thêm chúng vào đúng vị trí.
```javascript
// Gần đầu file server.js, cùng với các import khác
import streamRoutes from './routes/stream.js';

// ... (code khác của bạn ở giữa) ...

// Gần cuối file, trước dòng app.listen()
// Dòng này đăng ký tất cả các routes từ stream.js vào ứng dụng chính
app.use('/api', streamRoutes);
```

#### 2C. Cập nhật `backend/.env`
- Mở file `backend/.env` và thêm một biến môi trường mới.
- **QUAN TRỌNG:** Tự tạo một chuỗi ký tự ngẫu nhiên, dài và phức tạp cho giá trị này (ví dụ: dùng một trình tạo mật khẩu). Đây là "chìa khóa bí mật" để Lambda có thể gửi dữ liệu đến backend của bạn một cách an toàn.
```dotenv
# Thêm dòng này vào cuối file backend/.env
STREAM_INGEST_SECRET_KEY=your_super_long_and_secret_random_string_here
```

#### 2D. Khởi động lại Backend
Nếu bạn đang dùng `pm2` trên VPS, hãy khởi động lại ứng dụng backend để áp dụng tất cả các thay đổi:
```sh
pm2 restart ppc-auto-backend-gadnia
```

---

## Phần 2: Thiết lập Pipeline trên AWS

### Bước 3: AWS - Tạo IAM Role cho Lambda
Role này chỉ cần quyền cơ bản để chạy và ghi log.
1.  Mở dịch vụ **IAM** -> **Roles** -> **"Create role"**.
2.  **Trusted entity type:** Chọn **AWS service**, Use case: **Lambda**.
3.  **Add permissions:** Tìm và thêm policy `AWSLambdaBasicExecutionRole`.
4.  **Role name:** `gadnia-Lambda-StreamForwarder-Role`.
5.  Nhấp **"Create role"**.

### Bước 4: AWS - Tạo Lambda Function
Function này sẽ nhận dữ liệu từ Firehose và gửi nó đến API endpoint trên VPS của bạn.
1.  Mở dịch vụ **Lambda** -> **"Create function"**.
2.  **Function name:** `gadnia-process-and-forward-stream`.
3.  **Runtime:** **Node.js 20.x**.
4.  **Permissions:** Chọn **"Use an existing role"** và chọn `gadnia-Lambda-StreamForwarder-Role` (role bạn vừa tạo).
5.  Nhấp **"Create function"**.
6.  Trong tab **Code source**, dán toàn bộ nội dung từ file `lambda_deployment_package/process-and-forward-stream.mjs.txt` vào file `index.mjs`.
7.  Trong tab **Configuration** -> **Environment variables**, thêm 2 biến sau:
    -   Key: `INGEST_API_URL`, Value: `https://gadnia.tababyco.com/api/stream-ingest`.
    -   Key: `INGEST_API_KEY`, Value: Dán chuỗi bí mật bạn đã tạo ở **Bước 2C**.
8.  Trong **General configuration**, tăng **Timeout** lên `1 minute`.
9.  Nhấp **"Deploy Changes"**.

### Bước 5: AWS - Cấu hình Kinesis Data Firehose
Firehose sẽ nhận dữ liệu từ Amazon Ads và chuyển tiếp đến Lambda function của chúng ta.
1.  Mở dịch vụ **Amazon Kinesis** -> **Data Firehose** -> **"Create delivery stream"**.
2.  **Source:** Chọn **Direct PUT**.
3.  **Destination:** Chọn **AWS Lambda**.
4.  **Delivery stream name:** `gadnia-ads-stream-firehose`.
5.  Trong phần **"Destination settings"**:
    -   **Lambda function:** Chọn function bạn vừa tạo (`gadnia-process-and-forward-stream`).
    -   **Buffer hints:** Giữ nguyên giá trị mặc định (hoặc điều chỉnh nếu cần, ví dụ: 1MB, 60s).
6.  Trong phần **"Backup settings"**, chọn **"Failed data only"** và chọn một S3 bucket để lưu các bản ghi không xử lý được. Đây là bước quan trọng để gỡ lỗi.
7.  Nhấp **"Create delivery stream"**.
8.  Sau khi tạo xong, sao chép (copy) giá trị **ARN** của delivery stream này. Bạn sẽ cần nó cho file `.env`.

---

## Phần 3: Đăng ký Stream và Hoàn tất

### Bước 6: AWS - Tạo IAM Roles cho Amazon Ads
Để Amazon Ads API có thể gửi dữ liệu đến Firehose của bạn, chúng ta cần tạo hai IAM role đặc biệt theo yêu cầu của Amazon.

#### 6A. Tạo `Subscription Role` (Role cho Amazon ghi dữ liệu)
Role này được Amazon Ads "assume" (đóng vai) để có quyền ghi dữ liệu vào Firehose của bạn.
1.  Mở dịch vụ **IAM** -> **Roles** -> **"Create role"**.
2.  **Trusted entity type:** Chọn **Custom trust policy**.
3.  Dán đoạn JSON sau vào trình soạn thảo, **thay thế `YOUR_AWS_ACCOUNT_ID`** bằng ID tài khoản AWS của bạn:
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Principal": {
                    "Service": "sellingpartnerapi.amazon.com"
                },
                "Action": "sts:AssumeRole",
                "Condition": {
                    "StringEquals": {
                        "aws:SourceAccount": "YOUR_AWS_ACCOUNT_ID"
                    }
                }
            }
        ]
    }
    ```
4.  Nhấp **Next**.
5.  **Add permissions:** Nhấp **"Create policy"** (sẽ mở một tab mới).
    -   Trong tab mới, chọn tab **JSON**.
    -   Dán policy sau, **thay thế `YOUR_FIREHOSE_STREAM_ARN`** bằng ARN của Firehose bạn đã tạo ở Bước 5:
        ```json
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": "firehose:PutRecordBatch",
                    "Resource": "YOUR_FIREHOSE_STREAM_ARN"
                }
            ]
        }
        ```
    -   Nhấp **Next: Tags**, sau đó **Next: Review**.
    -   **Policy name:** `gadnia-AMS-FirehoseWrite-Policy`.
    -   Nhấp **"Create policy"**.
    -   Quay lại tab tạo Role, làm mới danh sách policy và tìm `gadnia-AMS-FirehoseWrite-Policy` rồi chọn nó.
6.  Nhấp **Next**.
7.  **Role name:** `gadnia-AMS-Subscription-Role`.
8.  Nhấp **"Create role"**.
9.  Sau khi tạo xong, vào trang chi tiết của role và sao chép giá trị **ARN** của nó.

#### 6B. Tạo `Subscriber Role` (Role cho bạn đăng ký stream)
Role này được bạn sử dụng khi chạy script đăng ký. Nó cấp cho bạn quyền `iam:PassRole`, cho phép bạn "trao" `Subscription Role` cho Amazon.
1.  Mở dịch vụ **IAM** -> **Roles** -> **"Create role"**.
2.  **Trusted entity type:** Chọn **AWS Account** và chọn **This account**.
3.  Nhấp **Next**.
4.  **Add permissions:** Nhấp **"Create policy"**.
    -   Trong tab mới, chọn tab **JSON**.
    -   Dán policy sau, **thay thế `YOUR_SUBSCRIPTION_ROLE_ARN`** bằng ARN của `gadnia-AMS-Subscription-Role` bạn vừa tạo ở bước 6A:
        ```json
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": "iam:PassRole",
                    "Resource": "YOUR_SUBSCRIPTION_ROLE_ARN"
                }
            ]
        }
        ```
    -   Nhấp **Next: Tags**, **Next: Review**.
    -   **Policy name:** `gadnia-AMS-PassRole-Policy`.
    -   Nhấp **"Create policy"**.
    -   Quay lại tab tạo Role, làm mới và tìm `gadnia-AMS-PassRole-Policy` rồi chọn nó.
5.  Nhấp **Next**.
6.  **Role name:** `gadnia-AMS-Subscriber-Role`.
7.  Nhấp **"Create role"**.
8.  Sau khi tạo xong, vào trang chi tiết của role và sao chép giá trị **ARN** của nó.

### Bước 7: Cập nhật file `.env` và Đăng ký Stream
1.  Mở file `backend/.env` trên VPS của bạn.
2.  Cập nhật các biến môi trường sau với các giá trị ARN bạn vừa sao chép:
    ```dotenv
    ADS_API_FIREHOSE_ARN=...ARN_của_gadnia-ads-stream-firehose...
    ADS_API_FIREHOSE_SUBSCRIPTION_ROLE_ARN=...ARN_của_gadnia-AMS-Subscription-Role...
    ADS_API_FIREHOSE_SUBSCRIBER_ROLE_ARN=...ARN_của_gadnia-AMS-Subscriber-Role...
    ```
3.  Từ thư mục gốc của dự án trên VPS, chạy script đăng ký:
    ```bash
    npm run stream:subscribe
    ```

### Bước 8: Kiểm tra
Sau khi đăng ký thành công, dữ liệu sẽ bắt đầu chảy.
- **Trên AWS:** Kiểm tra CloudWatch logs của Lambda `gadnia-process-and-forward-stream` để xem các thông báo "Successfully forwarded".
- **Trên VPS:** Kiểm tra logs của ứng dụng backend (ví dụ `pm2 logs ppc-auto-backend-gadnia`) để xem các thông báo "Successfully ingested".
- **Trong Database:** Truy vấn bảng `raw_stream_events` để thấy dữ liệu mới được thêm vào.

Chúc mừng! Bạn đã thiết lập thành công pipeline để đưa dữ liệu Marketing Stream vào PostgreSQL trên VPS của mình một cách hiệu quả và tiết kiệm chi phí.
