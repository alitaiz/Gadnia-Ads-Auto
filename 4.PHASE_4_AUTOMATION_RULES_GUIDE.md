# HÆ°á»›ng Dáº«n Chi Tiáº¿t Triá»ƒn Khai Giai Äoáº¡n 4: XÃ¢y dá»±ng Bá»™ mÃ¡y Tá»± Ä‘á»™ng hÃ³a Dá»±a trÃªn Luáº­t

## Giá»›i thiá»‡u

ChÃ o má»«ng báº¡n Ä‘áº¿n vá»›i Giai Ä‘oáº¡n 4, bÆ°á»›c Ä‘á»™t phÃ¡ biáº¿n á»©ng dá»¥ng cá»§a chÃºng ta tá»« má»™t cÃ´ng cá»¥ quáº£n lÃ½ thá»§ cÃ´ng thÃ nh má»™t trá»£ lÃ½ PPC thÃ´ng minh, lÃ m viá»‡c khÃ´ng má»‡t má»i 24/7. á»ž giai Ä‘oáº¡n nÃ y, chÃºng ta sáº½ xÃ¢y dá»±ng tÃ­nh nÄƒng cá»‘t lÃµi vÃ  máº¡nh máº½ nháº¥t: **bá»™ mÃ¡y tá»± Ä‘á»™ng hÃ³a dá»±a trÃªn luáº­t**.

**Má»¥c tiÃªu cuá»‘i cÃ¹ng cá»§a giai Ä‘oáº¡n nÃ y:**
-   Cho phÃ©p ngÆ°á»i dÃ¹ng táº¡o ra cÃ¡c "luáº­t" tá»‘i Æ°u hÃ³a tÃ¹y chá»‰nh (vÃ­ dá»¥: "Náº¾U ACOS cá»§a tá»« khÃ³a trong 7 ngÃ y qua > 40% VÃ€ cÃ³ hÆ¡n 10 clicks, THÃŒ giáº£m giÃ¡ tháº§u cá»§a tá»« khÃ³a Ä‘Ã³ Ä‘i 10%").
-   XÃ¢y dá»±ng má»™t "rules engine" (bá»™ mÃ¡y xá»­ lÃ½ luáº­t) á»Ÿ backend, cÃ³ kháº£ nÄƒng tá»± Ä‘á»™ng cháº¡y Ä‘á»‹nh ká»³ Ä‘á»ƒ kiá»ƒm tra dá»¯ liá»‡u vÃ  thá»±c thi cÃ¡c hÃ nh Ä‘á»™ng.
-   Cung cáº¥p má»™t giao diá»‡n trá»±c quan Ä‘á»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ táº¡o, quáº£n lÃ½ vÃ  theo dÃµi lá»‹ch sá»­ hoáº¡t Ä‘á»™ng cá»§a cÃ¡c luáº­t nÃ y.

Giai Ä‘oáº¡n nÃ y sáº½ giáº£i phÃ³ng ngÆ°á»i dÃ¹ng khá»i cÃ¡c cÃ´ng viá»‡c láº·p Ä‘i láº·p láº¡i, giÃºp há» táº­p trung vÃ o chiáº¿n lÆ°á»£c vÃ  Ä‘Æ°a ra cÃ¡c quyáº¿t Ä‘á»‹nh á»Ÿ táº§m cao hÆ¡n.

---

## Pháº§n A: Backend - XÃ¢y dá»±ng Bá»™ nÃ£o Tá»± Ä‘á»™ng hÃ³a

**Má»¥c tiÃªu:** Thiáº¿t káº¿ cÆ¡ sá»Ÿ dá»¯ liá»‡u vÃ  logic backend Ä‘á»ƒ lÆ°u trá»¯, xá»­ lÃ½ vÃ  thá»±c thi cÃ¡c luáº­t tá»± Ä‘á»™ng hÃ³a.

### BÆ°á»›c 1: Thiáº¿t káº¿ vÃ  Cáº­p nháº­t CÆ¡ sá»Ÿ dá»¯ liá»‡u

ChÃºng ta cáº§n hai báº£ng má»›i trong PostgreSQL Ä‘á»ƒ quáº£n lÃ½ há»‡ thá»‘ng tá»± Ä‘á»™ng hÃ³a.

1.  **Káº¿t ná»‘i vÃ o VPS vÃ  database cá»§a báº¡n** (tham kháº£o hÆ°á»›ng dáº«n `7.VIEWING_DATA_IN_POSTGRESQL.md` náº¿u cáº§n).

2.  **Cháº¡y cÃ¡c lá»‡nh SQL sau** Ä‘á»ƒ táº¡o cÃ¡c báº£ng `automation_rules` vÃ  `automation_logs`. HÃ£y cháº¯c cháº¯n ráº±ng báº¡n Ä‘Ã£ cáº¥p quyá»n cho ngÆ°á»i dÃ¹ng database cá»§a á»©ng dá»¥ng (`yourdbuser`) trÃªn cÃ¡c báº£ng nÃ y.

    ```sql
    -- Báº£ng lÆ°u trá»¯ táº¥t cáº£ cÃ¡c luáº­t tá»± Ä‘á»™ng hÃ³a do ngÆ°á»i dÃ¹ng táº¡o ra
    CREATE TABLE IF NOT EXISTS automation_rules (
        id SERIAL PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        is_active BOOLEAN DEFAULT true,
        -- Táº§n suáº¥t cháº¡y luáº­t (vÃ­ dá»¥: 'every_15_minutes', 'daily_at_midnight')
        frequency VARCHAR(50) NOT NULL,
        -- LÆ°u cÃ¡c Ä‘iá»u kiá»‡n dÆ°á»›i dáº¡ng JSON, vÃ­ dá»¥: [{"metric": "acos", "operator": ">", "value": 0.4}]
        conditions JSONB NOT NULL,
        -- LÆ°u cÃ¡c hÃ nh Ä‘á»™ng dÆ°á»›i dáº¡ng JSON, vÃ­ dá»¥: [{"action": "decrease_bid", "value": 0.1, "unit": "percent"}]
        actions JSONB NOT NULL,
        last_run_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Báº£ng ghi láº¡i má»i hÃ nh Ä‘á»™ng mÃ  bá»™ mÃ¡y tá»± Ä‘á»™ng hÃ³a Ä‘Ã£ thá»±c hiá»‡n
    CREATE TABLE IF NOT EXISTS automation_logs (
        id SERIAL PRIMARY KEY,
        rule_id INTEGER REFERENCES automation_rules(id) ON DELETE SET NULL,
        action_taken TEXT NOT NULL,
        target_entity_type VARCHAR(50), -- 'campaign', 'ad_group', 'keyword', 'target'
        target_entity_id BIGINT,
        details JSONB, -- LÆ°u chi tiáº¿t, vÃ­ dá»¥: { "old_bid": 1.5, "new_bid": 1.35 }
        status VARCHAR(50), -- 'SUCCESS' hoáº·c 'FAILURE'
        message TEXT, -- ThÃ´ng bÃ¡o lá»—i náº¿u cÃ³
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Cáº¥p quyá»n cho user cá»§a á»©ng dá»¥ng (THAY THáº¾ 'yourdbuser' Báº°NG TÃŠN USER Cá»¦A Báº N)
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE automation_rules, automation_logs TO yourdbuser;
    GRANT USAGE, SELECT ON SEQUENCE automation_rules_id_seq, automation_logs_id_seq TO yourdbuser;
    ```

### BÆ°á»›c 2: XÃ¢y dá»±ng "Rules Engine" - Bá»™ mÃ¡y Xá»­ lÃ½ Luáº­t

ÄÃ¢y lÃ  trÃ¡i tim cá»§a há»‡ thá»‘ng. ChÃºng ta sáº½ táº¡o má»™t service cháº¡y ná»n Ä‘á»‹nh ká»³ Ä‘á»ƒ thá»±c thi cÃ¡c luáº­t.

1.  **CÃ i Ä‘áº·t `node-cron`:**
    -   Trong thÆ° má»¥c `backend`, cháº¡y lá»‡nh: `npm install node-cron`

2.  **Táº¡o Service (`backend/services/rulesEngine.js`):**
    -   Táº¡o má»™t file má»›i Ä‘á»ƒ chá»©a toÃ n bá»™ logic. Service nÃ y sáº½ cÃ³ má»™t hÃ m `start()` Ä‘á»ƒ khá»Ÿi cháº¡y cron job.
    -   **Luá»“ng hoáº¡t Ä‘á»™ng cá»§a cron job (vÃ­ dá»¥ cháº¡y má»—i 15 phÃºt):**
        1.  **Láº¥y luáº­t:** Truy váº¥n báº£ng `automation_rules` Ä‘á»ƒ láº¥y táº¥t cáº£ cÃ¡c luáº­t Ä‘ang cÃ³ `is_active = true`.
        2.  **Láº¥y dá»¯ liá»‡u:** Vá»›i má»—i luáº­t, truy váº¥n cÃ¡c báº£ng dá»¯ liá»‡u hiá»‡u suáº¥t (vÃ­ dá»¥: BÃ¡o cÃ¡o Search Term hoáº·c dá»¯ liá»‡u stream Ä‘Ã£ tá»•ng há»£p theo tá»«ng tá»« khÃ³a) Ä‘á»ƒ láº¥y cÃ¡c chá»‰ sá»‘ cáº§n thiáº¿t (ACOS, clicks, spend, v.v.) trong khoáº£ng thá»i gian phÃ¹ há»£p (vÃ­ dá»¥ 7 ngÃ y qua).
        3.  **ÄÃ¡nh giÃ¡ Ä‘iá»u kiá»‡n:** Láº·p qua tá»«ng **tá»« khÃ³a (keyword)** hoáº·c **má»¥c tiÃªu (target)**. Vá»›i má»—i thá»±c thá»ƒ, so sÃ¡nh dá»¯ liá»‡u hiá»‡u suáº¥t cá»§a nÃ³ vá»›i cÃ¡c Ä‘iá»u kiá»‡n trong luáº­t.
        4.  **Thá»±c thi hÃ nh Ä‘á»™ng:** Náº¿u táº¥t cáº£ Ä‘iá»u kiá»‡n Ä‘á»u Ä‘Æ°á»£c thá»a mÃ£n, táº¡o má»™t payload cáº­p nháº­t vÃ  gá»i Ä‘áº¿n API `PUT /api/amazon/keywords` (sá»­ dá»¥ng helper `amazonAdsApiRequest`) Ä‘á»ƒ thá»±c hiá»‡n hÃ nh Ä‘á»™ng (vÃ­ dá»¥: thay Ä‘á»•i giÃ¡ tháº§u `bid`).
        5.  **Ghi log:** DÃ¹ thÃ nh cÃ´ng hay tháº¥t báº¡i, ghi láº¡i káº¿t quáº£ vÃ o báº£ng `automation_logs` vá»›i `target_entity_type = 'keyword'` vÃ  `target_entity_id` tÆ°Æ¡ng á»©ng.
        6.  **Cáº­p nháº­t luáº­t:** Cáº­p nháº­t trÆ°á»ng `last_run_at` cá»§a luáº­t trong báº£ng `automation_rules`.

3.  **TÃ­ch há»£p vÃ o Server (`backend/server.js`):**
    -   Import service vá»«a táº¡o vÃ  khá»Ÿi cháº¡y nÃ³ khi server báº¯t Ä‘áº§u.
    ```javascript
    // Trong file backend/server.js
    import { startRulesEngine } from './services/rulesEngine.js';
    
    // ... (sau khi cáº¥u hÃ¬nh app) ...
    
    app.listen(port, () => {
        console.log(`ðŸš€ Backend server is listening at http://localhost:${port}`);
        startRulesEngine(); // Khá»Ÿi cháº¡y bá»™ mÃ¡y tá»± Ä‘á»™ng hÃ³a!
    });
    ```

### BÆ°á»›c 3: Táº¡o API Endpoints Ä‘á»ƒ Quáº£n lÃ½ Luáº­t

Táº¡o má»™t file router má»›i (`backend/routes/automation.js`) Ä‘á»ƒ frontend cÃ³ thá»ƒ giao tiáº¿p vÃ  quáº£n lÃ½ cÃ¡c luáº­t.

-   `GET /api/automation/rules`: Láº¥y danh sÃ¡ch táº¥t cáº£ cÃ¡c luáº­t.
-   `POST /api/automation/rules`: Táº¡o má»™t luáº­t má»›i.
-   `PUT /api/automation/rules/:id`: Cáº­p nháº­t má»™t luáº­t (vÃ­ dá»¥: báº­t/táº¯t, thay Ä‘á»•i Ä‘iá»u kiá»‡n).
-   `DELETE /api/automation/rules/:id`: XÃ³a má»™t luáº­t.
-   `GET /api/automation/logs`: Láº¥y lá»‹ch sá»­ hoáº¡t Ä‘á»™ng tá»« báº£ng `automation_logs`.

---

## Pháº§n B: Frontend - XÃ¢y dá»±ng Giao diá»‡n Äiá»u khiá»ƒn

**Má»¥c tiÃªu:** Táº¡o má»™t giao diá»‡n ngÆ°á»i dÃ¹ng thÃ¢n thiá»‡n, cho phÃ©p ngÆ°á»i dÃ¹ng dá»… dÃ ng táº¡o vÃ  quáº£n lÃ½ cÃ¡c quy táº¯c tá»± Ä‘á»™ng hÃ³a phá»©c táº¡p.

### BÆ°á»›c 4: Táº¡o Trang "Automation"

1.  **Táº¡o View Má»›i (`views/AutomationView.tsx`):**
    -   Táº¡o má»™t component React má»›i. Component nÃ y sáº½ lÃ  trang chÃ­nh Ä‘á»ƒ quáº£n lÃ½ tá»± Ä‘á»™ng hÃ³a.
    -   NÃ³ sáº½ gá»i API `GET /api/automation/rules` Ä‘á»ƒ hiá»ƒn thá»‹ má»™t báº£ng danh sÃ¡ch cÃ¡c luáº­t hiá»‡n cÃ³.
    -   Má»—i hÃ ng trong báº£ng sáº½ cÃ³ cÃ¡c nÃºt Ä‘á»ƒ Sá»­a, XÃ³a, vÃ  má»™t cÃ´ng táº¯c (toggle) Ä‘á»ƒ Báº­t/Táº¯t luáº­t.

2.  **ThÃªm Route (`index.tsx`):**
    -   Cáº­p nháº­t file routing cá»§a báº¡n Ä‘á»ƒ thÃªm má»™t Ä‘Æ°á»ng dáº«n má»›i, vÃ­ dá»¥ `/automation`, trá» Ä‘áº¿n `AutomationView`.
    -   ThÃªm má»™t má»¥c "Automation" vÃ o thanh Ä‘iá»u hÆ°á»›ng (sidebar/header) cá»§a á»©ng dá»¥ng.

### BÆ°á»›c 5: XÃ¢y dá»±ng TrÃ¬nh táº¡o Luáº­t (Rule Builder)

ÄÃ¢y lÃ  thÃ nh pháº§n giao diá»‡n phá»©c táº¡p vÃ  quan trá»ng nháº¥t. NÃ³ cÃ³ thá»ƒ lÃ  má»™t modal hoáº·c má»™t trang riÃªng.

1.  **Giao diá»‡n Trá»±c quan:**
    -   **TÃªn & Tráº¡ng thÃ¡i:** Ã” nháº­p liá»‡u cho tÃªn luáº­t vÃ  má»™t cÃ´ng táº¯c Báº­t/Táº¯t.
    -   **Khá»‘i "IF" (Äiá»u kiá»‡n):**
        -   Cho phÃ©p ngÆ°á»i dÃ¹ng thÃªm má»™t hoáº·c nhiá»u Ä‘iá»u kiá»‡n.
        -   Má»—i Ä‘iá»u kiá»‡n lÃ  má»™t hÃ ng, bao gá»“m:
            -   **Dropdown chá»n Cáº¥p Ä‘á»™:** "Keyword", "Target".
            -   **Dropdown chá»n Chá»‰ sá»‘:** "ACOS", "Clicks", "Spend", "CTR", "Conversion Rate", etc.
            -   **Dropdown chá»n ToÃ¡n tá»­:** ">", "<", "=", ">=", "<=".
            -   **Ã” nháº­p liá»‡u cho GiÃ¡ trá»‹:** "40%", "10", "$50".
        -   Cho phÃ©p káº¿t há»£p cÃ¡c Ä‘iá»u kiá»‡n báº±ng logic "AND" (táº¥t cáº£ pháº£i Ä‘Ãºng).
    -   **Khá»‘i "THEN" (HÃ nh Ä‘á»™ng):**
        -   Cho phÃ©p ngÆ°á»i dÃ¹ng thÃªm má»™t hoáº·c nhiá»u hÃ nh Ä‘á»™ng sáº½ Ä‘Æ°á»£c thá»±c thi.
        -   Má»—i hÃ nh Ä‘á»™ng lÃ  má»™t hÃ ng, bao gá»“m:
            -   **Dropdown chá»n HÃ nh Ä‘á»™ng:** "Increase Bid", "Decrease Bid", "Set Bid to", "Pause Keyword", "Add Negative Keyword".
            -   **Ã” nháº­p liá»‡u cho GiÃ¡ trá»‹:** "10%", "$0.10".
    -   **Pháº¡m vi Ãp dá»¥ng:**
        -   Má»™t giao diá»‡n Ä‘á»ƒ chá»n cÃ¡c chiáº¿n dá»‹ch hoáº·c nhÃ³m quáº£ng cÃ¡o cá»¥ thá»ƒ mÃ  luáº­t nÃ y sáº½ Ã¡p dá»¥ng.
    -   **Táº§n suáº¥t:**
        -   Dropdown Ä‘á»ƒ chá»n táº§n suáº¥t cháº¡y: "Má»—i giá»", "HÃ ng ngÃ y", v.v.

2.  **Logic Component:**
    -   Sá»­ dá»¥ng state cá»§a React Ä‘á»ƒ quáº£n lÃ½ cáº¥u trÃºc cá»§a luáº­t Ä‘ang Ä‘Æ°á»£c táº¡o.
    -   Khi ngÆ°á»i dÃ¹ng lÆ°u, component sáº½ Ä‘Ã³ng gÃ³i state thÃ nh má»™t Ä‘á»‘i tÆ°á»£ng JSON vÃ  gá»­i nÃ³ Ä‘áº¿n API `POST /api/automation/rules` hoáº·c `PUT /api/automation/rules/:id`.

### BÆ°á»›c 6: Hiá»ƒn thá»‹ Lá»‹ch sá»­ (Automation Logs)

1.  **Táº¡o má»™t tab hoáº·c trang riÃªng** Ä‘á»ƒ hiá»ƒn thá»‹ lá»‹ch sá»­.
2.  Gá»i API `GET /api/automation/logs` vÃ  hiá»ƒn thá»‹ káº¿t quáº£ trong má»™t báº£ng.
3.  CÃ¡c cá»™t bao gá»“m: Thá»i gian, TÃªn Luáº­t, HÃ nh Ä‘á»™ng Ä‘Ã£ thá»±c hiá»‡n, Thá»±c thá»ƒ bá»‹ áº£nh hÆ°á»Ÿng, Káº¿t quáº£ (ThÃ nh cÃ´ng/Tháº¥t báº¡i), vÃ  Chi tiáº¿t.
4.  TÃ­nh nÄƒng nÃ y cá»±c ká»³ quan trá»ng Ä‘á»ƒ xÃ¢y dá»±ng lÃ²ng tin cá»§a ngÆ°á»i dÃ¹ng. Há» cáº§n biáº¿t chÃ­nh xÃ¡c há»‡ thá»‘ng Ä‘Ã£ lÃ m gÃ¬ thay máº·t há».

---

## HoÃ n táº¥t!

ChÃºc má»«ng báº¡n Ä‘Ã£ hoÃ n thÃ nh giai Ä‘oáº¡n phá»©c táº¡p nhÆ°ng cÅ©ng Ä‘Ã¡ng giÃ¡ nháº¥t! á»¨ng dá»¥ng cá»§a báº¡n giá» Ä‘Ã¢y khÃ´ng chá»‰ lÃ  má»™t cÃ´ng cá»¥ quáº£n lÃ½ mÃ  Ä‘Ã£ trá»Ÿ thÃ nh má»™t ná»n táº£ng tá»‘i Æ°u hÃ³a tá»± Ä‘á»™ng. NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ thiáº¿t láº­p cÃ¡c chiáº¿n lÆ°á»£c cá»§a riÃªng mÃ¬nh vÃ  Ä‘á»ƒ há»‡ thá»‘ng thá»±c thi chÃºng má»™t cÃ¡ch chÃ­nh xÃ¡c vÃ  khÃ´ng má»‡t má»i.

ÄÃ¢y lÃ  ná»n táº£ng vá»¯ng cháº¯c Ä‘á»ƒ phÃ¡t triá»ƒn cÃ¡c tÃ­nh nÄƒng nÃ¢ng cao hÆ¡n trong tÆ°Æ¡ng lai, nhÆ° sá»­ dá»¥ng AI Ä‘á»ƒ Ä‘á» xuáº¥t cÃ¡c luáº­t tá»‘i Æ°u hoáº·c tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh ngÃ¢n sÃ¡ch giá»¯a cÃ¡c chiáº¿n dá»‹ch.