# Hướng Dẫn Chi Tiết Triển Khai Giai Đoạn 4: Xây dựng Bộ máy Tự động hóa Dựa trên Luật

## Giới thiệu

Chào mừng bạn đến với Giai đoạn 4, bước đột phá biến ứng dụng của chúng ta từ một công cụ quản lý thủ công thành một trợ lý PPC thông minh, làm việc không mệt mỏi 24/7. Ở giai đoạn này, chúng ta sẽ xây dựng tính năng cốt lõi và mạnh mẽ nhất: **bộ máy tự động hóa dựa trên luật**.

**Mục tiêu cuối cùng của giai đoạn này:**
-   Cho phép người dùng tạo ra các "luật" tối ưu hóa tùy chỉnh (ví dụ: "NẾU ACOS của từ khóa trong 7 ngày qua > 40% VÀ có hơn 10 clicks, THÌ giảm giá thầu của từ khóa đó đi 10%").
-   Xây dựng một "rules engine" (bộ máy xử lý luật) ở backend, có khả năng tự động chạy định kỳ để kiểm tra dữ liệu và thực thi các hành động.
-   Cung cấp một giao diện trực quan để người dùng có thể tạo, quản lý và theo dõi lịch sử hoạt động của các luật này.

Giai đoạn này sẽ giải phóng người dùng khỏi các công việc lặp đi lặp lại, giúp họ tập trung vào chiến lược và đưa ra các quyết định ở tầm cao hơn.

---

## Phần A: Backend - Xây dựng Bộ não Tự động hóa

**Mục tiêu:** Thiết kế cơ sở dữ liệu và logic backend để lưu trữ, xử lý và thực thi các luật tự động hóa.

### Bước 1: Thiết kế và Cập nhật Cơ sở dữ liệu

Chúng ta cần hai bảng mới trong PostgreSQL để quản lý hệ thống tự động hóa.

1.  **Kết nối vào VPS và database của bạn** (tham khảo hướng dẫn `7.VIEWING_DATA_IN_POSTGRESQL.md` nếu cần).

2.  **Chạy các lệnh SQL sau** để tạo các bảng `automation_rules` và `automation_logs`. Hãy chắc chắn rằng bạn đã cấp quyền cho người dùng database của ứng dụng (`yourdbuser`) trên các bảng này.

    ```sql
    -- Bảng lưu trữ tất cả các luật tự động hóa do người dùng tạo ra
    CREATE TABLE IF NOT EXISTS automation_rules (
        id SERIAL PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        is_active BOOLEAN DEFAULT true,
        -- Tần suất chạy luật (ví dụ: 'every_15_minutes', 'daily_at_midnight')
        frequency VARCHAR(50) NOT NULL,
        -- Lưu các điều kiện dưới dạng JSON, ví dụ: [{"metric": "acos", "operator": ">", "value": 0.4}]
        conditions JSONB NOT NULL,
        -- Lưu các hành động dưới dạng JSON, ví dụ: [{"action": "decrease_bid", "value": 0.1, "unit": "percent"}]
        actions JSONB NOT NULL,
        last_run_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Bảng ghi lại mọi hành động mà bộ máy tự động hóa đã thực hiện
    CREATE TABLE IF NOT EXISTS automation_logs (
        id SERIAL PRIMARY KEY,
        rule_id INTEGER REFERENCES automation_rules(id) ON DELETE SET NULL,
        action_taken TEXT NOT NULL,
        target_entity_type VARCHAR(50), -- 'campaign', 'ad_group', 'keyword', 'target'
        target_entity_id BIGINT,
        details JSONB, -- Lưu chi tiết, ví dụ: { "old_bid": 1.5, "new_bid": 1.35 }
        status VARCHAR(50), -- 'SUCCESS' hoặc 'FAILURE'
        message TEXT, -- Thông báo lỗi nếu có
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Cấp quyền cho user của ứng dụng (THAY THẾ 'yourdbuser' BẰNG TÊN USER CỦA BẠN)
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE automation_rules, automation_logs TO yourdbuser;
    GRANT USAGE, SELECT ON SEQUENCE automation_rules_id_seq, automation_logs_id_seq TO yourdbuser;
    ```

### Bước 2: Xây dựng "Rules Engine" - Bộ máy Xử lý Luật

Đây là trái tim của hệ thống. Chúng ta sẽ tạo một service chạy nền định kỳ để thực thi các luật.

1.  **Cài đặt `node-cron`:**
    -   Trong thư mục `backend`, chạy lệnh: `npm install node-cron`

2.  **Tạo Service (`backend/services/rulesEngine.js`):**
    -   Tạo một file mới để chứa toàn bộ logic. Service này sẽ có một hàm `start()` để khởi chạy cron job.
    -   **Luồng hoạt động của cron job (ví dụ chạy mỗi 15 phút):**
        1.  **Lấy luật:** Truy vấn bảng `automation_rules` để lấy tất cả các luật đang có `is_active = true`.
        2.  **Lấy dữ liệu:** Với mỗi luật, truy vấn các bảng dữ liệu hiệu suất (ví dụ: Báo cáo Search Term hoặc dữ liệu stream đã tổng hợp theo từng từ khóa) để lấy các chỉ số cần thiết (ACOS, clicks, spend, v.v.) trong khoảng thời gian phù hợp (ví dụ 7 ngày qua).
        3.  **Đánh giá điều kiện:** Lặp qua từng **từ khóa (keyword)** hoặc **mục tiêu (target)**. Với mỗi thực thể, so sánh dữ liệu hiệu suất của nó với các điều kiện trong luật.
        4.  **Thực thi hành động:** Nếu tất cả điều kiện đều được thỏa mãn, tạo một payload cập nhật và gọi đến API `PUT /api/amazon/keywords` (sử dụng helper `amazonAdsApiRequest`) để thực hiện hành động (ví dụ: thay đổi giá thầu `bid`).
        5.  **Ghi log:** Dù thành công hay thất bại, ghi lại kết quả vào bảng `automation_logs` với `target_entity_type = 'keyword'` và `target_entity_id` tương ứng.
        6.  **Cập nhật luật:** Cập nhật trường `last_run_at` của luật trong bảng `automation_rules`.

3.  **Tích hợp vào Server (`backend/server.js`):**
    -   Import service vừa tạo và khởi chạy nó khi server bắt đầu.
    ```javascript
    // Trong file backend/server.js
    import { startRulesEngine } from './services/rulesEngine.js';
    
    // ... (sau khi cấu hình app) ...
    
    app.listen(port, () => {
        console.log(`🚀 Backend server is listening at http://localhost:${port}`);
        startRulesEngine(); // Khởi chạy bộ máy tự động hóa!
    });
    ```

### Bước 3: Tạo API Endpoints để Quản lý Luật

Tạo một file router mới (`backend/routes/automation.js`) để frontend có thể giao tiếp và quản lý các luật.

-   `GET /api/automation/rules`: Lấy danh sách tất cả các luật.
-   `POST /api/automation/rules`: Tạo một luật mới.
-   `PUT /api/automation/rules/:id`: Cập nhật một luật (ví dụ: bật/tắt, thay đổi điều kiện).
-   `DELETE /api/automation/rules/:id`: Xóa một luật.
-   `GET /api/automation/logs`: Lấy lịch sử hoạt động từ bảng `automation_logs`.

---

## Phần B: Frontend - Xây dựng Giao diện Điều khiển

**Mục tiêu:** Tạo một giao diện người dùng thân thiện, cho phép người dùng dễ dàng tạo và quản lý các quy tắc tự động hóa phức tạp.

### Bước 4: Tạo Trang "Automation"

1.  **Tạo View Mới (`views/AutomationView.tsx`):**
    -   Tạo một component React mới. Component này sẽ là trang chính để quản lý tự động hóa.
    -   Nó sẽ gọi API `GET /api/automation/rules` để hiển thị một bảng danh sách các luật hiện có.
    -   Mỗi hàng trong bảng sẽ có các nút để Sửa, Xóa, và một công tắc (toggle) để Bật/Tắt luật.

2.  **Thêm Route (`index.tsx`):**
    -   Cập nhật file routing của bạn để thêm một đường dẫn mới, ví dụ `/automation`, trỏ đến `AutomationView`.
    -   Thêm một mục "Automation" vào thanh điều hướng (sidebar/header) của ứng dụng.

### Bước 5: Xây dựng Trình tạo Luật (Rule Builder)

Đây là thành phần giao diện phức tạp và quan trọng nhất. Nó có thể là một modal hoặc một trang riêng.

1.  **Giao diện Trực quan:**
    -   **Tên & Trạng thái:** Ô nhập liệu cho tên luật và một công tắc Bật/Tắt.
    -   **Khối "IF" (Điều kiện):**
        -   Cho phép người dùng thêm một hoặc nhiều điều kiện.
        -   Mỗi điều kiện là một hàng, bao gồm:
            -   **Dropdown chọn Cấp độ:** "Keyword", "Target".
            -   **Dropdown chọn Chỉ số:** "ACOS", "Clicks", "Spend", "CTR", "Conversion Rate", etc.
            -   **Dropdown chọn Toán tử:** ">", "<", "=", ">=", "<=".
            -   **Ô nhập liệu cho Giá trị:** "40%", "10", "$50".
        -   Cho phép kết hợp các điều kiện bằng logic "AND" (tất cả phải đúng).
    -   **Khối "THEN" (Hành động):**
        -   Cho phép người dùng thêm một hoặc nhiều hành động sẽ được thực thi.
        -   Mỗi hành động là một hàng, bao gồm:
            -   **Dropdown chọn Hành động:** "Increase Bid", "Decrease Bid", "Set Bid to", "Pause Keyword", "Add Negative Keyword".
            -   **Ô nhập liệu cho Giá trị:** "10%", "$0.10".
    -   **Phạm vi Áp dụng:**
        -   Một giao diện để chọn các chiến dịch hoặc nhóm quảng cáo cụ thể mà luật này sẽ áp dụng.
    -   **Tần suất:**
        -   Dropdown để chọn tần suất chạy: "Mỗi giờ", "Hàng ngày", v.v.

2.  **Logic Component:**
    -   Sử dụng state của React để quản lý cấu trúc của luật đang được tạo.
    -   Khi người dùng lưu, component sẽ đóng gói state thành một đối tượng JSON và gửi nó đến API `POST /api/automation/rules` hoặc `PUT /api/automation/rules/:id`.

### Bước 6: Hiển thị Lịch sử (Automation Logs)

1.  **Tạo một tab hoặc trang riêng** để hiển thị lịch sử.
2.  Gọi API `GET /api/automation/logs` và hiển thị kết quả trong một bảng.
3.  Các cột bao gồm: Thời gian, Tên Luật, Hành động đã thực hiện, Thực thể bị ảnh hưởng, Kết quả (Thành công/Thất bại), và Chi tiết.
4.  Tính năng này cực kỳ quan trọng để xây dựng lòng tin của người dùng. Họ cần biết chính xác hệ thống đã làm gì thay mặt họ.

---

## Hoàn tất!

Chúc mừng bạn đã hoàn thành giai đoạn phức tạp nhưng cũng đáng giá nhất! Ứng dụng của bạn giờ đây không chỉ là một công cụ quản lý mà đã trở thành một nền tảng tối ưu hóa tự động. Người dùng có thể thiết lập các chiến lược của riêng mình và để hệ thống thực thi chúng một cách chính xác và không mệt mỏi.

Đây là nền tảng vững chắc để phát triển các tính năng nâng cao hơn trong tương lai, như sử dụng AI để đề xuất các luật tối ưu hoặc tự động điều chỉnh ngân sách giữa các chiến dịch.