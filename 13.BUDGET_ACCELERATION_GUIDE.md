# Hướng dẫn Triển khai Tính năng Tăng tốc Ngân sách (Budget Acceleration)

## 1. Tổng quan Giải pháp

Chúng ta sẽ tạo ra một loại Rule tự động hóa mới, gọi là **"Budget Acceleration"**. Rule này sẽ:
1.  **Chạy thường xuyên trong ngày** (ví dụ: mỗi 30 phút).
2.  **Phân tích dữ liệu stream** được thu thập từ đầu ngày cho đến thời điểm hiện tại.
3.  **Nếu** các chỉ số hiệu suất trong ngày (như ROAS, ACoS, số lượng đơn hàng) vượt qua một ngưỡng bạn đặt ra, **và** ngân sách trong ngày đã gần cạn, hệ thống sẽ tự động tăng ngân sách.
4.  Lưu lại **ngân sách gốc** của chiến dịch trước khi thay đổi.
5.  Vào **cuối ngày**, một quy trình riêng sẽ tự động **khôi phục** tất cả các chiến dịch về lại ngân sách gốc của chúng.

---

## 2. Luồng Hoạt động Chi tiết (Step-by-Step Workflow)

### 2.1. Lưu trữ Ngân sách Gốc
Để có thể khôi phục ngân sách, chúng ta cần một nơi để lưu trữ trạng thái ban đầu. Cách tốt nhất là tạo một bảng mới trong database.

-   **Bảng mới:** `daily_budget_overrides`
-   **Các cột:** `id`, `campaign_id`, `original_budget`, `override_date`, `reverted_at` (timestamp, nullable)
-   Bảng này sẽ ghi lại những chiến dịch nào đã được tăng ngân sách trong ngày, ngân sách gốc là bao nhiêu, và khi nào nó được khôi phục.

### 2.2. Cập nhật Rules Engine (`rulesEngine.js`)

-   **Tần suất cao hơn:** Rules Engine cần được cấu hình để có thể đánh giá các rule loại "Budget Acceleration" thường xuyên hơn, ví dụ mỗi 30 phút, thay vì chỉ chạy theo lịch cố định hàng giờ hoặc hàng ngày như các rule khác.
-   **Logic lấy dữ liệu mới:** Khi xử lý một rule "Budget Acceleration", thay vì truy vấn dữ liệu lịch sử từ `sponsored_products_search_term_report`, engine sẽ thực hiện một truy vấn đặc biệt vào bảng `raw_stream_events` để tổng hợp các chỉ số (spend, sales, orders, clicks) **chỉ trong ngày hôm nay** (từ 00:00 giờ đến thời điểm hiện tại theo múi giờ của tài khoản quảng cáo, ví dụ: `America/Los_Angeles`).

### 2.3. Điều kiện Kích hoạt (Trigger Condition)

Rule sẽ kiểm tra các điều kiện bạn đặt ra. Ví dụ:
-   `ROAS (Today) > 2.5`
-   `Spend (Today) > 75% của Ngân sách Gốc`

Điều kiện thứ hai rất quan trọng để đảm bảo chúng ta chỉ tăng ngân sách khi chiến dịch thực sự sắp hết tiền và đang hoạt động tốt.

### 2.4. Thực thi Hành động (Execution)

1.  **Bước 4a (Lấy Ngân sách Gốc):** Trước khi thay đổi, engine sẽ gọi API của Amazon để lấy ngân sách hiện tại của chiến dịch. Đây chính là `original_budget`.
2.  **Bước 4b (Ghi vào DB):** Engine sẽ ghi một bản ghi mới vào bảng `daily_budget_overrides` với `campaign_id` và `original_budget` vừa lấy được.
3.  **Bước 4c (Tăng Ngân sách):** Engine sẽ gọi API `PUT /sp/campaigns` của Amazon để cập nhật ngân sách lên giá trị mới (ví dụ: tăng 50%).

### 2.5. Khôi phục vào Cuối ngày (Daily Reset)

-   Một **cron job riêng biệt, cực kỳ đơn giản** sẽ được thiết lập để chạy một lần mỗi ngày vào lúc an toàn (ví dụ: 11:55 PM theo múi giờ tài khoản).
-   **Nhiệm vụ của cron job này:**
    1.  Truy vấn tất cả các bản ghi trong `daily_budget_overrides` cho ngày hôm nay mà chưa được khôi phục (`reverted_at IS NULL`).
    2.  Lặp qua từng bản ghi và gọi API `PUT /sp/campaigns` để đặt lại ngân sách của `campaign_id` về `original_budget`.
    3.  Cập nhật cột `reverted_at` để đánh dấu là đã khôi phục.

---

## 3. Cập nhật Giao diện Người dùng (UI/UX Design)

Để người dùng có thể sử dụng tính năng này, chúng ta cần cập nhật trang `AutomationView.tsx`:

### 3.1. Thêm Loại Rule Mới
-   Trong modal tạo/sửa rule, thêm một lựa chọn mới: **"Budget Acceleration Rule"**.

### 3.2. Tùy chỉnh Form cho Rule Mới
-   Khi người dùng chọn loại rule này, các tùy chọn trong form sẽ thay đổi:
    -   **Khối "IF" (Điều kiện):**
        -   **Time Window:** Chỉ cho phép chọn **"Today (so far)"**.
        -   **Metric:** Thêm các chỉ số đặc biệt như **"Budget Utilization % (Today)"**. Các chỉ số khác như `Sales (Today)`, `Orders (Today)`, `ROAS (Today)` vẫn giữ nguyên.
    -   **Khối "THEN" (Hành động):**
        -   **Action:** Chỉ cho phép các hành động như **"Increase budget by [X] %"** hoặc **"Set budget to $[Y]"**.
    -   **Hiển thị Thông báo Quan trọng:** Thêm một dòng chữ rõ ràng ngay bên dưới khối hành động:
        > ℹ️ *Ngân sách sẽ tự động được khôi phục về giá trị ban đầu vào cuối ngày.*
        
        Điều này giúp người dùng hiểu rõ cơ chế và cảm thấy an tâm khi sử dụng.

---

## 4. Ví dụ Thực tế

-   **Tên Rule:** `[SP-B] Tăng tốc khi ROAS cao`
-   **Loại Rule:** `Budget Acceleration`
-   **Áp dụng cho:** Chiến dịch Sản phẩm B
-   **Tần suất chạy:** Mỗi 30 phút.
-   **Logic:**
    -   **NẾU** `ROAS (Today) > 2.5` **VÀ** `Budget Utilization % (Today) > 75%`
    -   **THÌ** `Increase budget by 50%`

### Kịch bản

-   Chiến dịch có ngân sách gốc là **$50/ngày**.
-   Vào lúc 3 giờ chiều, hệ thống chạy và thấy rằng chiến dịch đã tiêu **$40 (80%)** và tạo ra **$120 doanh số (ROAS = 3.0)**.
-   Tất cả điều kiện được thỏa mãn.
-   Hệ thống ghi lại ngân sách gốc $50 vào bảng `daily_budget_overrides`.
-   Hệ thống gọi API Amazon và tăng ngân sách của chiến dịch lên **$75**.
-   Vào 11:55 PM, cron job khôi phục chạy, đọc từ bảng `daily_budget_overrides` và đặt lại ngân sách của chiến dịch về **$50** cho ngày mai.

---

## 5. Kết luận

Phương án này đáp ứng đầy đủ các yêu cầu của bạn: sử dụng dữ liệu stream, thực hiện hành động trong ngày, và khôi phục ngân sách. Nó tạo ra một hệ thống tự động hóa thông minh, linh hoạt và an toàn, giúp bạn không bỏ lỡ các cơ hội vàng trong những ngày bán hàng hiệu quả nhất.