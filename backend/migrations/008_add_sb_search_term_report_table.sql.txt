-- =============================================================================
-- Migration: Create/Update Sponsored Brands Search Term Report Table
-- =============================================================================
-- This script creates the table for storing daily Sponsored Brands Search Term
-- report data. It is designed to be idempotent and safe to re-run.
--

-- Create the table with a minimal structure if it doesn't already exist.
CREATE TABLE IF NOT EXISTS sponsored_brands_search_term_report (
    id SERIAL PRIMARY KEY,
    report_date DATE NOT NULL,
    campaign_id BIGINT,
    ad_group_id BIGINT,
    keyword_id BIGINT,
    customer_search_term TEXT
);

-- Add all required columns using the IF NOT EXISTS syntax to avoid errors on re-run.
ALTER TABLE sponsored_brands_search_term_report
    ADD COLUMN IF NOT EXISTS campaign_name TEXT,
    ADD COLUMN IF NOT EXISTS campaign_status VARCHAR(50),
    ADD COLUMN IF NOT EXISTS campaign_budget_type VARCHAR(50),
    ADD COLUMN IF NOT EXISTS campaign_budget_amount NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS ad_group_name TEXT,
    ADD COLUMN IF NOT EXISTS keyword_text TEXT,
    ADD COLUMN IF NOT EXISTS match_type VARCHAR(50),
    ADD COLUMN IF NOT EXISTS impressions BIGINT,
    ADD COLUMN IF NOT EXISTS clicks BIGINT,
    ADD COLUMN IF NOT EXISTS cost NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS cost_type VARCHAR(50),
    ADD COLUMN IF NOT EXISTS purchases BIGINT,
    ADD COLUMN IF NOT EXISTS sales NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS units_sold BIGINT,
    ADD COLUMN IF NOT EXISTS asin VARCHAR(50);


-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_sbstr_report_date ON sponsored_brands_search_term_report(report_date);
CREATE INDEX IF NOT EXISTS idx_sbstr_campaign_id ON sponsored_brands_search_term_report(campaign_id);
CREATE INDEX IF NOT EXISTS idx_sbstr_ad_group_id ON sponsored_brands_search_term_report(ad_group_id);
CREATE INDEX IF NOT EXISTS idx_sbstr_keyword_id ON sponsored_brands_search_term_report(keyword_id);
CREATE INDEX IF NOT EXISTS idx_sbstr_asin ON sponsored_brands_search_term_report(asin);

-- Define a unique constraint to prevent duplicate rows.
ALTER TABLE sponsored_brands_search_term_report
DROP CONSTRAINT IF EXISTS unique_sb_search_term_entry;

ALTER TABLE sponsored_brands_search_term_report
ADD CONSTRAINT unique_sb_search_term_entry
UNIQUE (report_date, campaign_id, ad_group_id, keyword_id, customer_search_term);

-- =============================================================================
-- Grant Permissions to Application User
-- =============================================================================
-- IMPORTANT: Replace 'gadnia' with the actual DB_USER from your .env file.
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE sponsored_brands_search_term_report TO gadnia;
GRANT USAGE, SELECT ON SEQUENCE sponsored_brands_search_term_report_id_seq TO gadnia;