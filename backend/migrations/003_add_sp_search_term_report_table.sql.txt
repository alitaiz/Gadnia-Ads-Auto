-- =============================================================================
-- Migration: Create/Update Sponsored Products Search Term Report Table
-- =============================================================================
-- This script creates the main table for storing daily Sponsored Products Search Term
-- report data. It's designed to be idempotent, meaning it can be run multiple
-- times without causing errors. It will create the table if it doesn't exist and
-- add any missing columns if it does. This version is updated to include ALL
-- available base metrics from the Amazon Ads API documentation.
--
-- V4: Made the script fully robust by ensuring ALL columns, including keyword_id,
-- are added with IF NOT EXISTS. This resolves migration failures on very old schemas.
--

-- Create the table with a minimal structure if it doesn't already exist.
CREATE TABLE IF NOT EXISTS sponsored_products_search_term_report (
    id SERIAL PRIMARY KEY,
    report_date DATE NOT NULL,
    campaign_id BIGINT,
    ad_group_id BIGINT,
    customer_search_term TEXT,
    targeting TEXT
);

-- Add all required columns using the simpler IF NOT EXISTS syntax.
-- This is much less prone to errors and ensures older schemas are updated correctly.
ALTER TABLE sponsored_products_search_term_report
    -- Dimensions
    ADD COLUMN IF NOT EXISTS keyword_id BIGINT, -- CRITICAL FIX: Ensure this column exists
    ADD COLUMN IF NOT EXISTS portfolio_id BIGINT,
    ADD COLUMN IF NOT EXISTS campaign_name TEXT,
    ADD COLUMN IF NOT EXISTS ad_group_name TEXT,
    ADD COLUMN IF NOT EXISTS keyword_text TEXT,
    ADD COLUMN IF NOT EXISTS keyword_type VARCHAR(50),
    ADD COLUMN IF NOT EXISTS match_type VARCHAR(50),
    ADD COLUMN IF NOT EXISTS asin VARCHAR(50),
    ADD COLUMN IF NOT EXISTS ad_keyword_status VARCHAR(50),
    ADD COLUMN IF NOT EXISTS campaign_status VARCHAR(50),
    ADD COLUMN IF NOT EXISTS campaign_budget_type VARCHAR(50),
    ADD COLUMN IF NOT EXISTS campaign_budget_amount NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS campaign_budget_currency_code VARCHAR(10),
    ADD COLUMN IF NOT EXISTS keyword_bid NUMERIC(10, 2),
    -- Performance Metrics
    ADD COLUMN IF NOT EXISTS impressions BIGINT,
    ADD COLUMN IF NOT EXISTS clicks BIGINT,
    ADD COLUMN IF NOT EXISTS cost NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS cost_per_click NUMERIC(10, 2),
    ADD COLUMN IF NOT EXISTS click_through_rate NUMERIC(10, 4),
    -- Conversion Metrics - Purchases
    ADD COLUMN IF NOT EXISTS purchases_1d BIGINT,
    ADD COLUMN IF NOT EXISTS purchases_7d BIGINT,
    ADD COLUMN IF NOT EXISTS purchases_14d BIGINT,
    ADD COLUMN IF NOT EXISTS purchases_30d BIGINT,
    -- Conversion Metrics - Sales
    ADD COLUMN IF NOT EXISTS sales_1d NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS sales_7d NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS sales_14d NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS sales_30d NUMERIC(12, 2),
    -- Conversion Metrics - Units Sold
    ADD COLUMN IF NOT EXISTS units_sold_clicks_1d BIGINT,
    ADD COLUMN IF NOT EXISTS units_sold_clicks_7d BIGINT,
    ADD COLUMN IF NOT EXISTS units_sold_clicks_14d BIGINT,
    ADD COLUMN IF NOT EXISTS units_sold_clicks_30d BIGINT,
    -- Same-SKU Metrics - Purchases
    ADD COLUMN IF NOT EXISTS purchases_same_sku_1d BIGINT,
    ADD COLUMN IF NOT EXISTS purchases_same_sku_7d BIGINT,
    ADD COLUMN IF NOT EXISTS purchases_same_sku_14d BIGINT,
    ADD COLUMN IF NOT EXISTS purchases_same_sku_30d BIGINT,
    -- Same-SKU Metrics - Sales
    ADD COLUMN IF NOT EXISTS attributed_sales_same_sku_1d NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS attributed_sales_same_sku_7d NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS attributed_sales_same_sku_14d NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS attributed_sales_same_sku_30d NUMERIC(12, 2),
    -- Same-SKU Metrics - Units
    ADD COLUMN IF NOT EXISTS units_sold_same_sku_1d BIGINT,
    ADD COLUMN IF NOT EXISTS units_sold_same_sku_7d BIGINT,
    ADD COLUMN IF NOT EXISTS units_sold_same_sku_14d BIGINT,
    ADD COLUMN IF NOT EXISTS units_sold_same_sku_30d BIGINT,
    -- Other-SKU Metrics
    ADD COLUMN IF NOT EXISTS sales_other_sku_7d NUMERIC(12, 2),
    ADD COLUMN IF NOT EXISTS units_sold_other_sku_7d BIGINT,
    -- Other Metrics
    ADD COLUMN IF NOT EXISTS acos_clicks_7d NUMERIC(10, 4),
    ADD COLUMN IF NOT EXISTS acos_clicks_14d NUMERIC(10, 4),
    ADD COLUMN IF NOT EXISTS roas_clicks_7d NUMERIC(10, 2),
    ADD COLUMN IF NOT EXISTS roas_clicks_14d NUMERIC(10, 2),
    ADD COLUMN IF NOT EXISTS add_to_list BIGINT,
    ADD COLUMN IF NOT EXISTS qualified_borrows BIGINT,
    ADD COLUMN IF NOT EXISTS royalty_qualified_borrows BIGINT,
    ADD COLUMN IF NOT EXISTS kenp_read_14d BIGINT,
    ADD COLUMN IF NOT EXISTS kenp_royalties_14d NUMERIC(10, 2);

-- Add indexes to frequently queried columns to improve performance
CREATE INDEX IF NOT EXISTS idx_sstr_report_date ON sponsored_products_search_term_report(report_date);
CREATE INDEX IF NOT EXISTS idx_sstr_campaign_id ON sponsored_products_search_term_report(campaign_id);
CREATE INDEX IF NOT EXISTS idx_sstr_ad_group_id ON sponsored_products_search_term_report(ad_group_id);
CREATE INDEX IF NOT EXISTS idx_sstr_keyword_id ON sponsored_products_search_term_report(keyword_id);
CREATE INDEX IF NOT EXISTS idx_sstr_asin ON sponsored_products_search_term_report(asin);

-- Define a unique constraint to prevent duplicate rows.
-- First, drop the old constraint if it exists, then add the new, correct one.
ALTER TABLE sponsored_products_search_term_report
DROP CONSTRAINT IF EXISTS unique_sp_search_term_entry;

ALTER TABLE sponsored_products_search_term_report
ADD CONSTRAINT unique_sp_search_term_entry
UNIQUE (report_date, campaign_id, ad_group_id, keyword_id, customer_search_term, targeting);

-- =============================================================================
-- Grant Permissions to Application User
-- =============================================================================
-- IMPORTANT: Replace 'gadnia' with the actual DB_USER from your .env file.
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE sponsored_products_search_term_report TO gadnia;
GRANT USAGE, SELECT ON SEQUENCE sponsored_products_search_term_report_id_seq TO gadnia;