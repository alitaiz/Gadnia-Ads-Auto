# Hướng Dẫn Chi Tiết Triển Khai Giai Đoạn 1: Nền tảng & Cài đặt Ban đầu

## Giới thiệu

Đây là hướng dẫn chi tiết dành cho người mới bắt đầu, giúp bạn triển khai **Giai đoạn 1** của dự án "Ứng dụng Quản lý & Tự động hóa Amazon PPC". Chúng ta sẽ đi từ một máy chủ ảo (VPS) trống đến việc chạy được phiên bản đầu tiên của ứng dụng.

**Mục tiêu cuối cùng của giai đoạn này:**
- Có một máy chủ an toàn trên internet.
- Cài đặt đầy đủ các phần mềm cần thiết.
- Ứng dụng backend và frontend có thể chạy và kết nối được với nhau.

Hãy làm theo từng bước một cách cẩn thận.

---

## Phần A: Chuẩn bị Hạ tầng trên VPS

### Bước 1: Thuê và Kết nối vào VPS

1.  **VPS là gì?** Hãy tưởng tượng bạn thuê một chiếc máy tính chạy 24/7 trong một trung tâm dữ liệu. Đó chính là VPS (Virtual Private Server).
2.  **Chọn nhà cung cấp:** Bạn có thể chọn một trong các nhà cung cấp uy tín sau:
    -   [DigitalOcean](https://www.digitalocean.com/)
    -   [Vultr](https://www.vultr.com/)
    -   [Linode](https://www.linode.com/)
3.  **Chọn hệ điều hành:** Khi tạo VPS, hãy chọn **Ubuntu 22.04**.
4.  **Kết nối vào VPS:**
    -   Sau khi tạo VPS, bạn sẽ nhận được một địa chỉ IP (ví dụ: `123.45.67.89`).
    -   **Trên Windows:** Dùng phần mềm [PuTTY](https://www.putty.org/) để kết nối.
    -   **Trên macOS hoặc Linux:** Mở Terminal và gõ lệnh sau (thay `your_vps_ip` bằng IP của bạn):
        ```bash
        ssh root@your_vps_ip
        ```
    -   Bạn sẽ được hỏi mật khẩu `root` mà nhà cung cấp đã cấp.

### Bước 2: Tạo Người dùng Mới (Bảo mật)

**Quan trọng:** Không nên dùng tài khoản `root` cho các công việc hàng ngày. Chúng ta sẽ tạo một người dùng mới có quyền quản trị.

1.  Tạo người dùng mới (thay `yourusername` bằng tên bạn muốn):
    ```bash
    adduser yourusername
    ```
2.  Cấp quyền `sudo` (quyền quản trị) cho người dùng mới:
    ```bash
    usermod -aG sudo yourusername
    ```
3.  Bây giờ, hãy đăng xuất khỏi `root` và đăng nhập lại bằng tài khoản mới của bạn:
    ```bash
    ssh yourusername@your_vps_ip
    ```
    Từ bây giờ, mọi lệnh quản trị sẽ có `sudo` ở đầu.

### Bước 3: Cài đặt các Phần mềm Cốt lõi

1.  **Cập nhật hệ thống:**
    ```bash
    sudo apt update && sudo apt upgrade -y
    ```
2.  **Cài đặt Nginx (Web Server):**
    -   Nginx sẽ đóng vai trò "người gác cổng", nhận yêu cầu từ người dùng và chuyển đến đúng nơi (frontend hoặc backend).
    -   Cài đặt:
        ```bash
        sudo apt install nginx -y
        ```
3.  **Cài đặt Node.js (Môi trường chạy Backend):**
    -   Chúng ta sẽ dùng `nvm` (Node Version Manager) để cài đặt Node.js, đây là cách tốt nhất.
    -   Chạy lệnh sau để cài `nvm`:
        ```bash
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
        ```
    -   Tải lại cấu hình terminal để sử dụng `nvm`:
        ```bash
        source ~/.bashrc
        ```
    -   Cài đặt phiên bản Node.js LTS (bản ổn định, được hỗ trợ lâu dài):
        ```bash
        nvm install --lts
        ```
4.  **Cài đặt PostgreSQL (Cơ sở dữ liệu):**
    -   Cài đặt PostgreSQL:
        ```bash
        sudo apt install postgresql postgresql-contrib -y
        ```
    -   Bây giờ, chúng ta cần tạo database và người dùng cho ứng dụng.
    -   Chuyển sang người dùng `postgres` mặc định của hệ thống:
        ```bash
        sudo -i -u postgres
        ```
    -   Tạo database:
        ```bash
        createdb amazon_data_gadnia
        ```
    -   Tạo người dùng mới cho database (bạn sẽ được hỏi tên và mật khẩu, hãy **ghi nhớ mật khẩu này**):
        ```bash
        createuser --interactive --pwprompt
        ```
        -   **Lưu ý:** Khi được hỏi tên, hãy nhập một tên người dùng mới (ví dụ: `gadnia`). **Không sử dụng tên `postgres`** vì đây là người dùng quản trị đã tồn tại.
        -   Ví dụ các bước:
            -   *Enter name of role to add:* `gadnia`
            -   *Enter password for new role:* `[Nhập_mật_khẩu_bảo_mật_của_bạn]`
            -   *Enter it again:* `[Nhập_lại_mật_khẩu]`
            -   *Shall the new role be a superuser? (y/n):* `n`
            -   *Shall the new role be allowed to create databases? (y/n):* `n`
            -   *Shall the new role be allowed to create more new roles? (y/n):* `n`
    -   Cấp quyền cho người dùng mới trên database:
        ```bash
        psql
        ```
        -   Trong giao diện `psql`, gõ lệnh sau (hãy thay `gadnia` bằng đúng tên người dùng bạn vừa tạo):
        ```sql
        GRANT ALL PRIVILEGES ON DATABASE amazon_data_gadnia TO gadnia;
        ```
        -   Thoát `psql` bằng lệnh `\q`.
    -   Trở về người dùng bình thường của bạn bằng lệnh `exit`.

### Bước 4: Cài đặt Trình quản lý & Tường lửa

1.  **Cài đặt PM2 (Process Manager):**
    -   PM2 giúp ứng dụng backend của bạn luôn chạy, kể cả khi bạn đóng cửa sổ terminal hoặc server khởi động lại.
    -   Cài đặt PM2 toàn cục:
        ```bash
        npm install pm2 -g
        ```
2.  **Cấu hình Tường lửa (UFW):**
    -   UFW (Uncomplicated Firewall) giúp bảo vệ server bằng cách chỉ mở những "cổng" cần thiết.
    -   Cho phép kết nối SSH (để bạn có thể đăng nhập):
        ```bash
        sudo ufw allow OpenSSH
        ```
    -   Cho phép kết nối web (HTTP và HTTPS):
        ```bash
        sudo ufw allow 'Nginx Full'
        ```
    -   Kích hoạt tường lửa:
        ```bash
        sudo ufw enable
        ```
        -   Khi được hỏi `Command may disrupt existing ssh connections. Proceed with operation (y|n)?`, gõ `y` và nhấn Enter.

---

## Phần B: Thiết lập Dự án

### Bước 5: Tải Code lên VPS

1.  **Cài đặt Git:**
    ```bash
    sudo apt install git -y
    ```
2.  **Tải code từ repository của bạn:**
    -   Thay `your_repository_url` bằng URL của repository Git của bạn.
    -   Chạy lệnh này trong thư mục home (`/home/yourusername`):
        ```bash
        git clone https://github.com/alitaiz/Gadnia-Ads-Auto
        ```
    -   Thao tác này sẽ tạo một thư mục mới chứa toàn bộ code dự án.

### Bước 6: Cài đặt Dependencies và Cấu hình

1.  **Cài đặt Dependencies cho Toàn bộ Dự án:**
    -   Di chuyển vào thư mục gốc của dự án (ví dụ: `cd Gadnia-Ads-Auto`).
    -   Chạy `npm install` một lần duy nhất tại đây. Lệnh này sẽ cài đặt tất cả các package cần thiết cho cả frontend và backend vào một thư mục `node_modules` duy nhất ở gốc.
        ```bash
        npm install
        ```
2.  **Cấu hình Biến môi trường cho Backend:**
    -   Đây là bước **quan trọng nhất**, nơi bạn cung cấp các "chìa khóa bí mật" cho ứng dụng.
    -   Di chuyển vào thư mục backend: `cd backend`
    -   Sao chép file cấu hình mẫu: `cp .env.example.txt .env`
    -   Mở file `.env` để chỉnh sửa: `nano .env`
    -   Điền các thông tin bạn đã tạo ở các bước trước:
        ```dotenv
        # PostgreSQL Connection Details
        DB_USER=gadnia
        DB_HOST=localhost
        DB_DATABASE=amazon_data_gadnia
        DB_PASSWORD=Khongbocuoc1
        DB_PORT=5432
        
        # Application Port
        PORT=4004

        # --- Amazon API Credentials ---
        # BẠN PHẢI LẤY CÁC GIÁ TRỊ NÀY TỪ TÀI KHOẢN AMAZON DEVELOPER CỦA MÌNH
        SP_API_CLIENT_ID=your_sp_api_client_id
        SP_API_CLIENT_SECRET=your_sp_api_client_secret
        SP_API_REFRESH_TOKEN=your_sp_api_refresh_token
        # ... điền tất cả các giá trị còn lại ...
        ```
    -   Sau khi chỉnh sửa xong, nhấn `Ctrl + X`, sau đó `Y` và `Enter` để lưu lại.
    -   Quay trở lại thư mục gốc: `cd ..`

---

## Phần C: Chạy Ứng dụng

### Bước 7: Build Frontend

-   Frontend cần được "build" thành các file HTML/CSS/JS tĩnh để Nginx có thể phục vụ cho người dùng.
-   Đảm bảo bạn đang ở thư mục gốc của dự án.
-   Chạy lệnh build:
    ```bash
    npm run build
    ```
-   Lệnh này sẽ tạo ra một thư mục mới tên là `dist` chứa kết quả.

### Bước 8: Cấu hình Nginx để phục vụ ứng dụng

1.  **Tạo file cấu hình mới cho trang web của bạn:**
    -   Chúng ta sẽ tạo file cấu hình cho `gadnia.tababyco.com`.
    ```bash
    sudo nano /etc/nginx/sites-available/gadnia.tababyco.com
    ```
2.  **Dán nội dung sau vào file:**
    -   **LƯU Ý QUAN TRỌNG:**
        -   `server_name` đã được cập nhật thành `gadnia.tababyco.com`.
        -   `proxy_pass` đã được cập nhật để trỏ đến backend đang chạy ở cổng `4004`.
        -   Bạn cần thay `/var/www/Gadnia-Ads-Auto/dist` bằng đường dẫn **CHÍNH XÁC** đến thư mục `dist` của bạn.
    ```nginx
    server {
        listen 80;
        server_name gadnia.tababyco.com; # Cập nhật tên miền của bạn

        # Đường dẫn đến thư mục build của frontend
        root /var/www/Gadnia-Ads-Auto/dist;
        index index.html;

        location / {
            # Cần thiết cho các ứng dụng Single Page Application (SPA) như React
            try_files $uri $uri/ /index.html;
        }

        # Chuyển tất cả yêu cầu /api/... đến backend
        location /api {
            proxy_pass http://localhost:4004; # Cập nhật cổng backend là 4004
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
    ```
3.  **Kích hoạt cấu hình:**
    ```bash
    sudo ln -s /etc/nginx/sites-available/gadnia.tababyco.com /etc/nginx/sites-enabled/
    ```
4.  **Kiểm tra và khởi động lại Nginx:**
    ```bash
    sudo nginx -t      # Lệnh này phải báo "syntax is ok" và "test is successful"
    sudo systemctl restart nginx
    ```

### Bước 9: Chạy Backend với PM2 (Phương pháp Tin cậy Nhất)

Lỗi `module is not defined in ES module scope` xảy ra vì `package.json` của bạn được cấu hình là `"type": "module"`, điều này gây ra xung đột khi PM2 cố gắng tải một file cấu hình JavaScript (`.js`).

Để giải quyết vấn đề này một cách triệt để và đơn giản nhất, chúng ta sẽ sử dụng một file cấu hình định dạng JSON (`ecosystem.json`). Đây là định dạng được PM2 khuyến nghị và nó hoàn toàn không bị ảnh hưởng bởi các vấn đề về module của Node.js.

1.  **Dừng và Xóa tiến trình cũ (Bắt buộc):**
    -   Nếu bạn đã chạy ứng dụng với PM2 trước đây, bạn **phải** xóa tiến trình cũ để áp dụng cấu hình mới.
        ```bash
        pm2 stop ppc-auto-backend-gadnia
        pm2 delete ppc-auto-backend-gadnia
        ```
    -   Nếu lệnh báo lỗi "not found", bạn có thể bỏ qua bước này.

2.  **Khởi động ứng dụng bằng file cấu hình JSON:**
    -   Đảm bảo bạn đang ở trong thư mục gốc của dự án (ví dụ: `cd /var/www/Gadnia-Ads-Auto`).
    -   Chạy lệnh sau, trỏ đến file `.json` mới:
        ```bash
        pm2 start ecosystem.json
        ```
    -   PM2 sẽ đọc file cấu hình JSON và thực thi `npm run server:start`, giải quyết hoàn toàn lỗi.

3.  **Lưu lại danh sách ứng dụng:**
    -   Lệnh này đảm bảo PM2 sẽ tự động khởi động lại backend của bạn sau khi server reboot.
        ```bash
        pm2 save
        ```
4.  **Kiểm tra trạng thái:**
    ```bash
    pm2 list
    ```
    -   Bạn sẽ thấy `ppc-auto-backend-gadnia` có trạng thái là `online`.
    -   Kiểm tra log để xác nhận không còn lỗi:
        ```bash
        pm2 logs ppc-auto-backend-gadnia
        ```
    -   Lỗi `ReferenceError: module is not defined` sẽ được giải quyết hoàn toàn.

---

## Hoàn tất!

Bây giờ bạn có thể mở trình duyệt và truy cập vào **http://gadnia.tababyco.com**. Bạn sẽ thấy giao diện ứng dụng của mình. Giai đoạn 1 đã hoàn thành!

**Để kiểm tra lỗi (nếu có):**
-   Lỗi backend: `pm2 logs ppc-auto-backend-gadnia`
-   Lỗi Nginx: `sudo journalctl -u nginx`