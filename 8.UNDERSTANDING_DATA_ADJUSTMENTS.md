# Hiểu về Dữ liệu Điều chỉnh (Giá trị Âm) trong Amazon Marketing Stream

## Giới thiệu

Khi làm việc với dữ liệu từ Amazon Marketing Stream, đặc biệt là khi truy vấn trực tiếp bảng `raw_stream_events`, bạn có thể sẽ bắt gặp các giá trị âm cho các chỉ số như `impressions` hoặc `clicks`.

**Đây không phải là lỗi.** Đây là một tính năng được thiết kế có chủ đích của luồng dữ liệu thời gian thực và việc hiểu nó là rất quan trọng để tính toán chính xác các chỉ số hiệu suất.

---

## Tại sao lại có Giá trị Âm?

Hãy coi dữ liệu từ Amazon như một sổ kế toán động. Quá trình này diễn ra theo hai giai đoạn:

1.  **Ghi nhận Ban đầu (Rất nhanh):** Khi một người dùng xem hoặc nhấp vào quảng cáo của bạn, Amazon sẽ gửi một sự kiện với giá trị dương (ví dụ: `impressions: 1`) gần như ngay lập tức. Điều này giúp bạn có được dữ liệu sơ bộ một cách nhanh chóng.

2.  **Xác thực và Điều chỉnh (Chậm hơn):** Sau đó, các hệ thống phức tạp của Amazon sẽ phân tích lưu lượng truy cập này để xác định tính hợp lệ của nó. Họ sẽ lọc ra:
    -   Lượt xem/click từ các bot đã biết.
    -   Các click đúp không chủ ý.
    -   Hoạt động bị nghi ngờ là gian lận.
    -   Lưu lượng truy cập không hợp lệ khác.

Khi một sự kiện đã được ghi nhận trước đó bị xác định là không hợp lệ, Amazon sẽ gửi một **sự kiện điều chỉnh** mới với **giá trị âm** tương ứng để "hoàn tác" lại sự kiện ban đầu.

**Ví dụ thực tế:**
-   `10:00:01 AM`: Một quảng cáo được hiển thị. Amazon gửi: `{ "impressions": 1, ... }`
-   `10:00:02 AM`: Một quảng cáo khác được hiển thị. Amazon gửi: `{ "impressions": 1, ... }`
-   `10:05:00 AM`: Hệ thống xác thực của Amazon phát hiện rằng sự kiện lúc `10:00:01` là từ một con bot.
-   `10:05:01 AM`: Amazon gửi sự kiện điều chỉnh: `{ "impressions": -1, ... }`

Nếu bạn chỉ xem các sự kiện riêng lẻ, giá trị `-1` có vẻ lạ. Nhưng nếu bạn tính tổng, kết quả sẽ là `1 + 1 + (-1) = 1`, đây là con số chính xác cuối cùng.

---

## Cách Xử lý Đúng là gì?

**Luôn luôn sử dụng hàm tổng hợp `SUM()` khi tính toán các chỉ số.**

Không bao giờ lấy giá trị `impressions` hoặc `clicks` từ một hàng (row) duy nhất và coi đó là giá trị cuối cùng. Thay vào đó, bạn phải nhóm (GROUP BY) theo các chiều bạn quan tâm (như `campaign_id`, `keyword_id`, `report_date`) và tính `SUM()` của các chỉ số đó.

**Ví dụ SQL đúng:**
```sql
SELECT
    event_data->>'campaign_id' as campaign_id,
    SUM((event_data->>'impressions')::integer) as total_impressions,
    SUM((event_data->>'clicks')::integer) as total_clicks,
    SUM((event_data->>'cost')::numeric) as total_spend
FROM
    raw_stream_events
WHERE
    event_type = 'sp-traffic' AND received_at >= 'YYYY-MM-DD'
GROUP BY
    campaign_id;
```
Cách tiếp cận này đảm bảo rằng tất cả các điều chỉnh (giá trị âm) sẽ được tự động trừ đi, cho bạn con số chính xác cuối cùng.

## Ảnh hưởng đến Ứng dụng của Bạn

-   **Backend:** Các endpoint API trong ứng dụng của bạn (ví dụ: `/api/stream/metrics`) đã được thiết kế để sử dụng `SUM()`. Do đó, các chỉ số hiển thị trên giao diện người dùng **đã chính xác**.
-   **Truy vấn Thủ công:** Khi bạn tự mình truy vấn cơ sở dữ liệu để kiểm tra hoặc gỡ lỗi (như trong hướng dẫn `7.VIEWING_DATA_IN_POSTGRESQL.md`), điều quan trọng là bạn phải nhớ sử dụng `SUM()` để có được bức tranh toàn cảnh đúng đắn.
