# Hướng Dẫn: Xem và Truy vấn Dữ liệu Trực tiếp trong PostgreSQL

## Giới thiệu

Đôi khi, cách tốt nhất để hiểu điều gì đang xảy ra hoặc để gỡ lỗi là xem trực tiếp dữ liệu thô mà ứng dụng của bạn đã thu thập. Hướng dẫn này sẽ chỉ cho bạn cách kết nối vào cơ sở dữ liệu PostgreSQL trên VPS của bạn và thực hiện một số câu lệnh SQL cơ bản để kiểm tra dữ liệu từ Amazon Marketing Stream và các báo cáo khác.

**Khi nào bạn cần dùng đến hướng dẫn này?**
-   Khi bạn muốn xác minh rằng dữ liệu từ Amazon Marketing Stream đang thực sự được ghi vào database.
-   Khi bạn muốn xem cấu trúc chi tiết của một sự kiện stream để hiểu các trường dữ liệu bên trong.
-   Khi bạn cần gỡ lỗi tại sao một chỉ số nào đó không hiển thị đúng trên giao diện.
-   Khi bạn cần xóa dữ liệu của một ngày bị lỗi để tải lại.

---

## Các bước Thực hiện

### Bước 1: Kết nối vào Database

1.  **Đăng nhập vào VPS của bạn qua SSH:**
    ```bash
    ssh yourusername@your_vps_ip
    ```

2.  **Chuyển sang người dùng `postgres`:** Đây là người dùng quản trị mặc định của PostgreSQL trên Ubuntu.
    ```bash
    sudo -i -u postgres
    ```

3.  **Kết nối vào database của ứng dụng:**
    -   Tên database của chúng ta là `amazon_data_gadnia`.
    ```bash
    psql -d amazon_data_gadnia
    ```
    -   Sau khi chạy lệnh này, dấu nhắc lệnh của bạn sẽ thay đổi thành `amazon_data_gadnia=#`, cho biết bạn đã kết nối thành công và sẵn sàng để chạy các lệnh SQL.

### Bước 2: Các Lệnh `psql` Hữu ích

Trước khi truy vấn dữ liệu, đây là một vài lệnh "meta" của `psql` rất hữu ích (chúng bắt đầu bằng dấu `\`):
-   `\l`: Liệt kê tất cả các database có trên server.
-   `\dt`: (Describe Tables) Liệt kê tất cả các bảng trong database `amazon_data_gadnia` mà bạn đang kết nối.
-   `\d raw_stream_events`: Mô tả chi tiết các cột và kiểu dữ liệu của bảng `raw_stream_events`.
-   `\q`: Thoát khỏi `psql` và quay trở lại terminal.

### Bước 3: Các Câu lệnh SQL Mẫu để Truy vấn Dữ liệu

Bây giờ là phần chính. Dưới đây là một số câu lệnh `SELECT` bạn có thể sao chép và dán vào `psql` để xem dữ liệu.

**Lưu ý:** Luôn kết thúc một câu lệnh SQL bằng dấu chấm phẩy `;`.

#### 1. Xem 10 sự kiện stream gần nhất

Câu lệnh này rất tốt để kiểm tra xem có dữ liệu mới đang chảy vào hay không.

```sql
SELECT id, event_type, received_at FROM raw_stream_events ORDER BY received_at DESC LIMIT 10;
```
-   **Kết quả mong đợi:** Bạn sẽ thấy một danh sách 10 hàng, cho biết loại sự kiện (`sp-traffic`, `sp-conversion`) và thời gian chúng được ghi lại.

#### 2. Đếm số lượng sự kiện theo loại trong ngày hôm nay

Câu lệnh này giúp bạn xác nhận rằng cả hai loại dữ liệu traffic và conversion đều đang được nhận.

```sql
SELECT event_type, COUNT(*) as event_count
FROM raw_stream_events
WHERE received_at >= date_trunc('day', NOW())
GROUP BY event_type;
```
-   **Kết quả mong đợi:** Một bảng nhỏ cho thấy có bao nhiêu sự kiện `sp-traffic` và bao nhiêu sự kiện `sp-conversion` đã được ghi trong ngày hôm nay.

#### 3. Xem chi tiết nội dung của một sự kiện `sp-traffic`

Dữ liệu chi tiết nằm trong cột `event_data` dưới dạng JSON. Để xem nó một cách dễ đọc, chúng ta sẽ bật chế độ hiển thị mở rộng.

1.  Bật chế độ xem mở rộng:
    ```sql
    \x on
    ```
2.  Chạy câu lệnh `SELECT`:
    ```sql
    SELECT event_data FROM raw_stream_events WHERE event_type = 'sp-traffic' LIMIT 1;
    ```
    -   **Kết quả mong đợi:** Bạn sẽ thấy toàn bộ cấu trúc JSON của một sự kiện traffic, được định dạng theo từng dòng, giúp bạn dễ dàng xem các trường như `campaignId`, `impressions`, `clicks`, `cost`, v.v.

3.  Tắt chế độ xem mở rộng để quay lại chế độ xem bảng bình thường:
    ```sql
    \x off
    ```

#### 4. Kiểm tra dữ liệu từ Báo cáo Search Term

Nếu bạn đã chạy các script để tải báo cáo lịch sử, bạn có thể kiểm tra dữ liệu trong bảng tương ứng.

```sql
SELECT report_date, campaign_name, customer_search_term, impressions, clicks, cost
FROM sponsored_products_search_term_report
ORDER BY report_date DESC, impressions DESC
LIMIT 10;
```
-   **Kết quả mong đợi:** Bạn sẽ thấy 10 dòng dữ liệu search term có nhiều lượt hiển thị nhất từ lần chạy báo cáo gần nhất.

#### 5. Tính toán Tổng số Impressions một cách Chính xác (Xử lý giá trị âm)

Như đã đề cập, dữ liệu stream có thể chứa các giá trị âm để điều chỉnh. Để có được con số chính xác, bạn phải luôn sử dụng hàm `SUM()`.

Câu lệnh này sẽ tính tổng số impressions cho mỗi chiến dịch trong ngày hôm nay, xử lý đúng các giá trị âm.

```sql
SELECT
    event_data->>'campaign_id' as campaign,
    SUM((event_data->>'impressions')::integer) as total_impressions
FROM
    raw_stream_events
WHERE
    event_type = 'sp-traffic'
    AND received_at >= date_trunc('day', NOW())
GROUP BY
    campaign
ORDER BY
    total_impressions DESC;
```
-   **Kết quả mong đợi:** Một danh sách các ID chiến dịch và tổng số impressions thực tế của chúng trong ngày hôm nay.
-   **Để hiểu sâu hơn về lý do tại sao có giá trị âm**, hãy xem tài liệu mới: [8. Hiểu về Dữ liệu Điều chỉnh](./8.UNDERSTANDING_DATA_ADJUSTMENTS.md).

### Bước 4: Xóa Dữ liệu của một Ngày Cụ thể (Để Tải lại)

Đôi khi bạn có thể cần xóa dữ liệu của một ngày cụ thể để có thể chạy lại các script fetch và tải lại dữ liệu mới (ví dụ: nếu bạn nghi ngờ dữ liệu lần trước bị lỗi hoặc không đầy đủ). Dưới đây là cách thực hiện một cách an toàn.

**CẢNH BÁO:** Lệnh `DELETE` sẽ xóa vĩnh viễn dữ liệu. Hãy thực hiện một cách cẩn thận và đảm bảo bạn đã chọn đúng ngày.

1.  **Bắt đầu một Giao dịch (Transaction) an toàn:**
    Bằng cách sử dụng `BEGIN;`, bạn có thể xem trước các thay đổi. Nếu bạn hài lòng, hãy dùng `COMMIT;` để lưu lại. Nếu bạn mắc lỗi, hãy dùng `ROLLBACK;` để hủy bỏ mọi thứ.
    ```sql
    BEGIN;
    ```

2.  **Thực thi các lệnh Xóa:**
    Thay thế `'YYYY-MM-DD'` bằng ngày bạn muốn xóa.

    ```sql
    -- Xóa khỏi Báo cáo Search Term
    DELETE FROM sponsored_products_search_term_report WHERE report_date = '2024-09-06';

    DELETE FROM sponsored_products_search_term_report WHERE report_date BETWEEN '2024-08-01' AND '2024-09-08';

    -- Xóa khỏi Báo cáo Sales & Traffic (theo ASIN)
    DELETE FROM sales_and_traffic_by_asin WHERE report_date = '2025-09-07';

    -- Xóa khỏi Báo cáo Sales & Traffic (theo Ngày)
    DELETE FROM sales_and_traffic_by_date WHERE report_date = '2025-09-07';
    
    -- (Tùy chọn) Xóa khỏi Hàng đợi Yêu cầu Báo cáo
    -- Nếu bạn sử dụng quy trình tải dữ liệu hai giai đoạn, bạn cũng nên xóa yêu cầu tương ứng
    -- khỏi bảng `report_requests` để script có thể tạo lại yêu cầu mới cho ngày đó.
    DELETE FROM report_requests WHERE report_date = '2024-09-06';
    ```

3.  **Hoàn tất Giao dịch:**
    -   Sau khi chạy các lệnh xóa, bạn có thể kiểm tra lại bằng lệnh `SELECT` để chắc chắn rằng dữ liệu đã biến mất.
    -   Nếu mọi thứ đều đúng, hãy lưu lại thay đổi:
    ```sql
    COMMIT;
    ```
    -   Nếu bạn muốn hủy bỏ, hãy chạy:
    ```sql
    ROLLBACK;
    ```

---

## Hoàn tất

Khi bạn đã xem xong, chỉ cần gõ `\q` và nhấn Enter để thoát khỏi `psql`. Sau đó, gõ `exit` và nhấn Enter để trở về người dùng thông thường của bạn.

Bằng cách truy vấn trực tiếp cơ sở dữ liệu, bạn có toàn quyền kiểm soát và khả năng hiển thị đối với dữ liệu của mình, đây là một kỹ năng vô giá trong quá trình phát triển và vận hành ứng dụng.